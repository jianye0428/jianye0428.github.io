<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>PyTorch Dataset And DataLoader - yejian's blog</title><meta name=author content="Jian YE"><meta name=author-link content="https://github.com/jianye0428"><meta name=description content="ref: [1] https://chenllliang.github.io/2020/02/04/dataloader/ [2] https://blog.csdn.net/zyq12345678/article/details/90268668 [3] https://cloud.tencent.com/developer/article/1877393 Dataset PyTorch为我们提供的两个Dataset和DataLoader类分别负责可被Pytorch使用的数据集的创建以及向训练传递数据的任务。如果想个性化自己的数据集或者数据传递方式，也可以自己重写子类。 Dataset是DataLoader实例化的一个参数，所以这篇文章会先从Datase"><meta name=keywords content="draft"><meta itemprop=name content="PyTorch Dataset And DataLoader"><meta itemprop=description content="ref: [1] https://chenllliang.github.io/2020/02/04/dataloader/ [2] https://blog.csdn.net/zyq12345678/article/details/90268668 [3] https://cloud.tencent.com/developer/article/1877393 Dataset PyTorch为我们提供的两个Dataset和DataLoader类分别负责可被Pytorch使用的数据集的创建以及向训练传递数据的任务。如果想个性化自己的数据集或者数据传递方式，也可以自己重写子类。 Dataset是DataLoader实例化的一个参数，所以这篇文章会先从Datase"><meta itemprop=datePublished content="2023-07-15T18:16:08+08:00"><meta itemprop=dateModified content="2023-07-15T18:58:05+08:00"><meta itemprop=wordCount content="5908"><meta itemprop=image content="https://jianye0428.github.io/images/favicon/jian_icon.png"><meta itemprop=keywords content="draft,"><meta property="og:title" content="PyTorch Dataset And DataLoader"><meta property="og:description" content="ref: [1] https://chenllliang.github.io/2020/02/04/dataloader/ [2] https://blog.csdn.net/zyq12345678/article/details/90268668 [3] https://cloud.tencent.com/developer/article/1877393 Dataset PyTorch为我们提供的两个Dataset和DataLoader类分别负责可被Pytorch使用的数据集的创建以及向训练传递数据的任务。如果想个性化自己的数据集或者数据传递方式，也可以自己重写子类。 Dataset是DataLoader实例化的一个参数，所以这篇文章会先从Datase"><meta property="og:type" content="article"><meta property="og:url" content="https://jianye0428.github.io/posts/datasetanddataloader/"><meta property="og:image" content="https://jianye0428.github.io/images/favicon/jian_icon.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-15T18:16:08+08:00"><meta property="article:modified_time" content="2023-07-15T18:58:05+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jianye0428.github.io/images/favicon/jian_icon.png"><meta name=twitter:title content="PyTorch Dataset And DataLoader"><meta name=twitter:description content="ref: [1] https://chenllliang.github.io/2020/02/04/dataloader/ [2] https://blog.csdn.net/zyq12345678/article/details/90268668 [3] https://cloud.tencent.com/developer/article/1877393 Dataset PyTorch为我们提供的两个Dataset和DataLoader类分别负责可被Pytorch使用的数据集的创建以及向训练传递数据的任务。如果想个性化自己的数据集或者数据传递方式，也可以自己重写子类。 Dataset是DataLoader实例化的一个参数，所以这篇文章会先从Datase"><meta name=application-name content="菠菜阿九时代峰峻啊；数量可根据；"><meta name=apple-mobile-web-app-title content="菠菜阿九时代峰峻啊；数量可根据；"><meta name=theme-color data-light=#ffffff data-dark=#252627 content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/png href=/jian_icon.png><link rel=icon type=image/png sizes=32x32 href=/jian_icon.png><link rel=icon type=image/png sizes=16x16 href=/jian_icon.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://jianye0428.github.io/posts/datasetanddataloader/><link rel=prev href=https://jianye0428.github.io/posts/pytorchnotes/><link rel=next href=https://jianye0428.github.io/posts/pythonnotes1/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"PyTorch Dataset And DataLoader","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/jianye0428.github.io\/posts\/datasetanddataloader\/"},"image":["https:\/\/jianye0428.github.io\/images\/favicon\/jian_icon.png"],"genre":"posts","keywords":"draft","wordcount":5908,"url":"https:\/\/jianye0428.github.io\/posts\/datasetanddataloader\/","datePublished":"2023-07-15T18:16:08+08:00","dateModified":"2023-07-15T18:58:05+08:00","publisher":{"@type":"Organization","name":"Jian YE","logo":"https:\/\/jianye0428.github.io\/images\/favicon\/jian_icon.png"},"author":{"@type":"Person","name":"Jian YE"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title="yejian's blog"><img loading=lazy src=/images/favicon/jian_icon.png srcset="/images/favicon/jian_icon.png, /images/favicon/jian_icon.png 1.5x, /images/favicon/jian_icon.png 2x" sizes=auto data-title="yejian's blog" data-alt="yejian's blog" class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Jian's Blog</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class="menu-item has-children"><a class=menu-link href=/about/><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden=true></i> 关于</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/projects/ title=项目><i class="fa-solid fa-laptop-code fa-fw fa-sm" aria-hidden=true></i> 我的项目</a></li></ul></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="yejian's blog"><img loading=lazy src=/images/favicon/jian_icon.png srcset="/images/favicon/jian_icon.png, /images/favicon/jian_icon.png 1.5x, /images/favicon/jian_icon.png 2x" sizes=auto data-title=/images/favicon/jian_icon.png data-alt=/images/favicon/jian_icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Jian's Blog</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/about/><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden=true></i> 关于</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/projects/ title=项目><i class="fa-solid fa-laptop-code fa-fw fa-sm" aria-hidden=true></i> 我的项目</a></li></ul></li><li class="menu-item text-center"><a class=menu-link href=https://github.com/jianye0428/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw' aria-hidden=true></i></a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class="container container-reverse"><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>PyTorch Dataset And DataLoader</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/jianye0428 title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img loading=lazy src="https://gravatar.loli.net/avatar/75a41975a5281767bf6bdba838de4238?s=32&amp;d=mp" srcset="https://gravatar.loli.net/avatar/75a41975a5281767bf6bdba838de4238?s=32&amp;d=mp, https://gravatar.loli.net/avatar/75a41975a5281767bf6bdba838de4238?s=32&amp;d=mp 1.5x, https://gravatar.loli.net/avatar/75a41975a5281767bf6bdba838de4238?s=32&amp;d=mp 2x" sizes=auto data-title="Jian YE" data-alt="Jian YE" class=avatar style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>&nbsp;Jian YE</a></span>
<span class=post-category>收录于 <a href=/categories/draft/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> draft</a></span></div><div class=post-meta-line><span title="发布于 2023-07-15 18:16:08"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2023-07-15>2023-07-15</time></span>&nbsp;<span title="更新于 2023-07-15 18:58:05"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2023-07-15>2023-07-15</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 5908 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 12 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="PyTorch Dataset And DataLoader">
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#dataset>Dataset</a><ul><li><a href=#什么时候使用dataset>什么时候使用Dataset</a></li><li><a href=#如何定义一个自己的数据集合>如何定义一个自己的数据集合</a><ul><li><a href=#map式数据集>Map式数据集</a></li></ul></li><li><a href=#iterable数据集>Iterable数据集</a></li></ul></li><li><a href=#dataloader>DataLoader</a></li><li><a href=#参数介绍>参数介绍</a><ul><li><a href=#采样器>采样器</a><ul><li><a href=#pytorch自带的sampler>PyTorch自带的Sampler</a></li></ul></li><li><a href=#多线程>多线程</a></li><li><a href=#dataloader-和-dataset-简单举例>DataLoader 和 Dataset 简单举例</a></li></ul></li><li><a href=#demo1---mlps-dataset-and-dataloader>DEMO1 - MLP&rsquo;s Dataset and DataLoader</a></li><li><a href=#demo2---lanegcns-dataset-and-dataloader>DEMO2 - LaneGCN&rsquo;s Dataset and DataLoader</a></li></ul></nav></div></div><div class=content id=content data-end-flag=（完）><p>ref:</br>[1] <a href=https://chenllliang.github.io/2020/02/04/dataloader/ target=_blank rel="external nofollow noopener noreferrer">https://chenllliang.github.io/2020/02/04/dataloader/<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></br>[2] <a href=https://blog.csdn.net/zyq12345678/article/details/90268668 target=_blank rel="external nofollow noopener noreferrer">https://blog.csdn.net/zyq12345678/article/details/90268668<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></br>[3] <a href=https://cloud.tencent.com/developer/article/1877393 target=_blank rel="external nofollow noopener noreferrer">https://cloud.tencent.com/developer/article/1877393<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></br></br></p><h2 id=dataset>Dataset</h2><p>PyTorch为我们提供的两个<code>Dataset</code>和<code>DataLoader</code>类分别负责可被Pytorch使用的数据集的创建以及向训练传递数据的任务。如果想个性化自己的数据集或者数据传递方式，也可以自己重写子类。</p><p>Dataset是DataLoader实例化的一个参数，所以这篇文章会先从Dataset的源代码讲起，然后讲到DataLoader，关注主要函数，少细枝末节，目的是使大家学会自定义自己的数据集。</p><h3 id=什么时候使用dataset>什么时候使用Dataset</h3><p>CIFAR10是CV训练中经常使用到的一个数据集，在PyTorch中CIFAR10是一个写好的Dataset，我们使用时只需以下代码：</p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>datasets</span><span class=o>.</span><span class=n>CIFAR10</span><span class=p>(</span><span class=s2>&#34;./data/&#34;</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>transform</span><span class=p>,</span> <span class=n>train</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>download</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>datasets.CIFAR10就是一个Datasets子类，data是这个类的一个实例。</p><p>我们有的时候需要用自己在一个文件夹中的数据作为数据集，这个时候，我们可以使用ImageFolder这个方便的API。</p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>FaceDataset</span> <span class=o>=</span> <span class=n>datasets</span><span class=o>.</span><span class=n>ImageFolder</span><span class=p>(</span><span class=s1>&#39;./data&#39;</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>img_transform</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><h3 id=如何定义一个自己的数据集合>如何定义一个自己的数据集合</h3><p><code>torch.utils.data.dataset</code> 是一个表示数据集的抽象类。任何自定义的数据集都需要继承这个类并覆写相关方法。</p><p>所谓数据集，其实就是一个负责处理索引(index)到样本(sample)映射的一个类(class)。</p><p>Pytorch提供两种数据集：</p><ul><li>Map式数据集</li><li>Iterable式数据集</li></ul><h4 id=map式数据集>Map式数据集</h4><p>一个Map式的数据集必须要重写<code>__getitem__(self, index)</code>, <code>len(self)</code> 两个内建方法，用来表示从索引到样本的映射(Map).</p><p>这样一个数据集dataset，举个例子，当使用dataset[idx]命令时，可以在你的硬盘中读取你的数据集中第idx张图片以及其标签（如果有的话）;len(dataset)则会返回这个数据集的容量。</p><p>例子-1： 自己实验中写的一个例子：这里我们的图片文件储存在“./data/faces/”文件夹下，图片的名字并不是从1开始，而是从final_train_tag_dict.txt这个文件保存的字典中读取，label信息也是用这个文件中读取。大家可以照着上面的注释阅读这段代码。</p><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torch.utils</span> <span class=kn>import</span> <span class=n>data</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>face_dataset</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>file_path</span> <span class=o>=</span> <span class=s1>&#39;./data/faces/&#39;</span>
</span></span><span class=line><span class=cl>		<span class=n>f</span><span class=o>=</span><span class=nb>open</span><span class=p>(</span><span class=s2>&#34;final_train_tag_dict.txt&#34;</span><span class=p>,</span><span class=s2>&#34;r&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>label_dict</span><span class=o>=</span><span class=nb>eval</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=n>label</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>label_dict</span><span class=o>.</span><span class=n>values</span><span class=p>())[</span><span class=n>index</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>img_id</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>label_dict</span><span class=o>.</span><span class=n>keys</span><span class=p>())[</span><span class=n>index</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=n>img_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>file_path</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>img_id</span><span class=p>)</span><span class=o>+</span><span class=s2>&#34;.jpg&#34;</span>
</span></span><span class=line><span class=cl>		<span class=n>img</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>img_path</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>img</span><span class=p>,</span><span class=n>label</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>label_dict</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>下面我们看一下官方MNIST数据集的例子</p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>MNIST</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;`MNIST &lt;http://yann.lecun.com/exdb/mnist/&gt;`_ Dataset. Args: root (string): Root directory of dataset where ``processed/training.pt`` and ``processed/test.pt`` exist. train (bool, optional): If True, creates dataset from ``training.pt``, otherwise from ``test.pt``. download (bool, optional): If true, downloads the dataset from the internet and puts it in root directory. If dataset is already downloaded, it is not downloaded again. transform (callable, optional): A function/transform that takes in an PIL image and returns a transformed version. E.g, ``transforms.RandomCrop`` target_transform (callable, optional): A function/transform that takes in the target and transforms it. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>urls</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;http://yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;http://yann.lecun.com/exdb/mnist/train-labels-idx1-ubyte.gz&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;http://yann.lecun.com/exdb/mnist/t10k-images-idx3-ubyte.gz&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;http://yann.lecun.com/exdb/mnist/t10k-labels-idx1-ubyte.gz&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>raw_folder</span> <span class=o>=</span> <span class=s1>&#39;raw&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>processed_folder</span> <span class=o>=</span> <span class=s1>&#39;processed&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>training_file</span> <span class=o>=</span> <span class=s1>&#39;training.pt&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>test_file</span> <span class=o>=</span> <span class=s1>&#39;test.pt&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>classes</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;0 - zero&#39;</span><span class=p>,</span> <span class=s1>&#39;1 - one&#39;</span><span class=p>,</span> <span class=s1>&#39;2 - two&#39;</span><span class=p>,</span> <span class=s1>&#39;3 - three&#39;</span><span class=p>,</span> <span class=s1>&#39;4 - four&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=s1>&#39;5 - five&#39;</span><span class=p>,</span> <span class=s1>&#39;6 - six&#39;</span><span class=p>,</span> <span class=s1>&#39;7 - seven&#39;</span><span class=p>,</span> <span class=s1>&#39;8 - eight&#39;</span><span class=p>,</span> <span class=s1>&#39;9 - nine&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>class_to_idx</span> <span class=o>=</span> <span class=p>{</span><span class=n>_class</span><span class=p>:</span> <span class=n>i</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>_class</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>classes</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>targets</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>train</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>train_labels</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>test_labels</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>root</span><span class=p>,</span> <span class=n>train</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>target_transform</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>download</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>root</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>expanduser</span><span class=p>(</span><span class=n>root</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>transform</span> <span class=o>=</span> <span class=n>transform</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>target_transform</span> <span class=o>=</span> <span class=n>target_transform</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>train</span> <span class=o>=</span> <span class=n>train</span>  <span class=c1># training set or test set</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>download</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>download</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_check_exists</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s1>&#39;Dataset not found.&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                               <span class=s1>&#39; You can use download=True to download it&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>train</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>train_data</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>train_labels</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>load</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>processed_folder</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>training_file</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>test_data</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>test_labels</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>load</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>processed_folder</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>test_file</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34; Args: index (int): Index Returns: tuple: (image, target) where target is index of the target class. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>train</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>img</span><span class=p>,</span> <span class=n>target</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>train_data</span><span class=p>[</span><span class=n>index</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>train_labels</span><span class=p>[</span><span class=n>index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>img</span><span class=p>,</span> <span class=n>target</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>test_data</span><span class=p>[</span><span class=n>index</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>test_labels</span><span class=p>[</span><span class=n>index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># doing this so that it is consistent with all other datasets         # to return a PIL Image         img = Image.fromarray(img.numpy(), mode=&#39;L&#39;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>transform</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>img</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>transform</span><span class=p>(</span><span class=n>img</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>target_transform</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>target</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>target_transform</span><span class=p>(</span><span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>img</span><span class=p>,</span> <span class=n>target</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>train</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>train_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>test_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_check_exists</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>processed_folder</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>training_file</span><span class=p>))</span> <span class=ow>and</span> \
</span></span><span class=line><span class=cl>            <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>processed_folder</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>test_file</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>download</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Download the MNIST data if it doesn&#39;t exist in processed_folder already.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>six.moves</span> <span class=kn>import</span> <span class=n>urllib</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>gzip</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_check_exists</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># download files         try:</span>
</span></span><span class=line><span class=cl>            <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_folder</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>processed_folder</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>OSError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>errno</span> <span class=o>==</span> <span class=n>errno</span><span class=o>.</span><span class=n>EEXIST</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>url</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>urls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Downloading &#39;</span> <span class=o>+</span> <span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>urllib</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>urlopen</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>filename</span> <span class=o>=</span> <span class=n>url</span><span class=o>.</span><span class=n>rpartition</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>file_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_folder</span><span class=p>,</span> <span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;.gz&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>),</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>out_f</span><span class=p>,</span> \
</span></span><span class=line><span class=cl>                    <span class=n>gzip</span><span class=o>.</span><span class=n>GzipFile</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span> <span class=k>as</span> <span class=n>zip_f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>out_f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>zip_f</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>os</span><span class=o>.</span><span class=n>unlink</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># process and save as torch files         print(&#39;Processing...&#39;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>training_set</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>read_image_file</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_folder</span><span class=p>,</span> <span class=s1>&#39;train-images-idx3-ubyte&#39;</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=n>read_label_file</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_folder</span><span class=p>,</span> <span class=s1>&#39;train-labels-idx1-ubyte&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>test_set</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>read_image_file</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_folder</span><span class=p>,</span> <span class=s1>&#39;t10k-images-idx3-ubyte&#39;</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=n>read_label_file</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_folder</span><span class=p>,</span> <span class=s1>&#39;t10k-labels-idx1-ubyte&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>processed_folder</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>training_file</span><span class=p>),</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>torch</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>training_set</span><span class=p>,</span> <span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>processed_folder</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>test_file</span><span class=p>),</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>torch</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>test_set</span><span class=p>,</span> <span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Done!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>fmt_str</span> <span class=o>=</span> <span class=s1>&#39;Dataset &#39;</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>fmt_str</span> <span class=o>+=</span> <span class=s1>&#39; Number of datapoints: </span><span class=si>{}</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=fm>__len__</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>tmp</span> <span class=o>=</span> <span class=s1>&#39;train&#39;</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>train</span> <span class=ow>is</span> <span class=kc>True</span> <span class=k>else</span> <span class=s1>&#39;test&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>fmt_str</span> <span class=o>+=</span> <span class=s1>&#39; Split: </span><span class=si>{}</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>tmp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>fmt_str</span> <span class=o>+=</span> <span class=s1>&#39; Root Location: </span><span class=si>{}</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>tmp</span> <span class=o>=</span> <span class=s1>&#39; Transforms (if any): &#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>fmt_str</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=si>{0}{1}</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>tmp</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>transform</span><span class=o>.</span><span class=fm>__repr__</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=s1>&#39; &#39;</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>tmp</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>tmp</span> <span class=o>=</span> <span class=s1>&#39; Target Transforms (if any): &#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>fmt_str</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=si>{0}{1}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>tmp</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>target_transform</span><span class=o>.</span><span class=fm>__repr__</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=s1>&#39; &#39;</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>tmp</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>fmt_str</span></span></span></code></pre></td></tr></table></div></div><h3 id=iterable数据集>Iterable数据集</h3><p>一个Iterable（迭代）式数据集是抽象类data.IterableDataset的子类，并且覆写了__iter__方法成为一个迭代器。这种数据集主要用于数据大小未知，或者以流的形式的输入，本地文件不固定的情况，需要以迭代的方式来获取样本索引。</p><p>关于迭代器与生成器的知识可以参见博主的另一篇文章Python迭代器与生成器介绍及在Pytorch源码中应用[https://chenllliang.github.io/2020/02/06/PyIter/]。</p><h2 id=dataloader>DataLoader</h2><blockquote><p>Data loader. Combines a dataset and a sampler, and provides an iterable over the given dataset. –PyTorch Documents</p></blockquote><p>一般来说PyTorch中深度学习训练的流程是这样的：</p><ol><li>创建Dateset</li><li>Dataset传递给DataLoader</li><li>DataLoader迭代产生训练数据提供给模型</li></ol><p>对应的一般都会有这三部分代码</p><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 创建Dateset(可以自定义)</span>
</span></span><span class=line><span class=cl><span class=n>dataset</span> <span class=o>=</span> <span class=n>face_dataset</span> <span class=c1># Dataset部分自定义过的face_dataset</span>
</span></span><span class=line><span class=cl><span class=c1># Dataset传递给DataLoader</span>
</span></span><span class=line><span class=cl><span class=n>dataloader</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>utils</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>DataLoader</span><span class=p>(</span><span class=n>dataset</span><span class=p>,</span><span class=n>batch_size</span><span class=o>=</span><span class=mi>64</span><span class=p>,</span><span class=n>shuffle</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span><span class=n>num_workers</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># DataLoader迭代产生训练数据提供给模型</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>epoch</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>index</span><span class=p>,(</span><span class=n>img</span><span class=p>,</span><span class=n>label</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>dataloader</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span></span></span></code></pre></td></tr></table></div></div><p>到这里应该就PyTorch的数据集和数据传递机制应该就比较清晰明了了。Dataset负责建立索引到样本的映射，DataLoader负责以特定的方式从数据集中迭代的产生 一个个batch的样本集合。在enumerate过程中实际上是dataloader按照其参数sampler规定的策略调用了其dataset的getitem方法。</p><h2 id=参数介绍>参数介绍</h2><p>先看一下实例化一个DataLoader所需的参数，我们只关注几个重点即可。</p><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>DataLoader</span><span class=p>(</span><span class=n>dataset</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>shuffle</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>sampler</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=n>batch_sampler</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>num_workers</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>collate_fn</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=n>pin_memory</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>drop_last</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=n>worker_init_fn</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>参数介绍:</p><ul><li><code>dataset</code> (Dataset) – 定义好的Map式或者Iterable式数据集。</li><li><code>batch_size</code> (python:int, optional) – 一个batch含有多少样本 (default: 1)。</li><li><code>shuffle</code> (bool, optional) – 每一个epoch的batch样本是相同还是随机 (default: False)。</li><li><code>sampler</code> (Sampler, optional) – 决定数据集中采样的方法. 如果有，则shuffle参数必须为False。</li><li><code>batch_sampler</code> (Sampler, optional) – 和 sampler 类似，但是一次返回的是一个batch内所有样本的index。和 batch_size, shuffle, sampler, and drop_last 三个参数互斥。</li><li><code>num_workers</code> (python:int, optional) – 多少个子程序同时工作来获取数据，多线程。 (default: 0)</li><li><code>collate_fn</code> (callable, optional) – 合并样本列表以形成小批量。</li><li><code>pin_memory</code> (bool, optional) – 如果为True，数据加载器在返回前将张量复制到CUDA固定内存中。</li><li><code>drop_last</code> (bool, optional) – 如果数据集大小不能被batch_size整除，设置为True可删除最后一个不完整的批处理。如果设为False并且数据集的大小不能被batch_size整除，则最后一个batch将更小。(default: False)</li><li><code>timeout</code> (numeric, optional) – 如果是正数，表明等待从worker进程中收集一个batch等待的时间，若超出设定的时间还没有收集到，那就不收集这个内容了。这个numeric应总是大于等于0。 (default: 0)</li><li><code>worker_init_fn</code> (callable, optional) – 每个worker初始化函数 (default: None)</li></ul><p>dataset 没什么好说的，很重要，需要按照前面所说的两种dataset定义好，完成相关函数的重写。</p><p>batch_size 也没啥好说的，就是训练的一个批次的样本数。</p><p>shuffle 表示每一个epoch中训练样本的顺序是否相同，一般True。</p><h3 id=采样器>采样器</h3><p><code>sampler</code> 重点参数，采样器，是一个迭代器。PyTorch提供了多种采样器，用户也可以自定义采样器。</p><p>所有sampler都是继承 <code>torch.utils.data.sampler.Sampler</code>这个抽象类。</p><p>关于迭代器的基础知识在博主这篇文章中可以找到Python迭代器与生成器介绍及在Pytorch源码中应用。[]</p><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Sampler</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># &#34;&#34;&#34;Base class for all Samplers.     # Every Sampler subclass has to provide an __iter__ method, providing a way     # to iterate over indices of dataset elements, and a __len__ method that     # returns the length of the returned iterators.     # &#34;&#34;&#34;     # 一个 迭代器 基类     def __init__(self, data_source):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>NotImplementedError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>NotImplementedError</span></span></span></code></pre></td></tr></table></div></div><h4 id=pytorch自带的sampler>PyTorch自带的Sampler</h4><ul><li>SequentialSampler</li><li>RandomSampler</li><li>SubsetRandomSampler</li><li>WeightedRandomSampler</li></ul><p><strong>SequentialSampler</strong> 很好理解就是顺序采样器。</p><p>其原理是首先在初始化的时候拿到数据集<code>data_source</code>，之后在<code>__iter__</code>方法中首先得到一个和data_source一样长度的<code>range</code>可迭代器。每次只会返回一个索引值。</p><div class=highlight id=id-8><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>SequentialSampler</span><span class=p>(</span><span class=n>Sampler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># r&#34;&#34;&#34;Samples elements sequentially, always in the same order.     # Arguments:     # data_source (Dataset): dataset to sample from     # &#34;&#34;&#34;    # 产生顺序 迭代器     def __init__(self, data_source):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_source</span> <span class=o>=</span> <span class=n>data_source</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>iter</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>data_source</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>data_source</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>参数作用:</p><ul><li><code>data_source</code>: 同上</li><li><code>num_sampler</code>: 指定采样的数量，默认是所有。</li><li><code>replacement</code>: 若为True，则表示可以重复采样，即同一个样本可以重复采样，这样可能导致有的样本采样不到。所以此时我们可以设置num_samples来增加采样数量使得每个样本都可能被采样到。</li></ul><div class=highlight id=id-9><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>RandomSampler</span><span class=p>(</span><span class=n>Sampler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># r&#34;&#34;&#34;Samples elements randomly. If without replacement, then sample from a shuffled dataset.     # If with replacement, then user can specify ``num_samples`` to draw.     # Arguments:     # data_source (Dataset): dataset to sample from     # num_samples (int): number of samples to draw, default=len(dataset)     # replacement (bool): samples are drawn with replacement if ``True``, default=False     # &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data_source</span><span class=p>,</span> <span class=n>replacement</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>num_samples</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_source</span> <span class=o>=</span> <span class=n>data_source</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>replacement</span> <span class=o>=</span> <span class=n>replacement</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>num_samples</span> <span class=o>=</span> <span class=n>num_samples</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_samples</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>replacement</span> <span class=ow>is</span> <span class=kc>False</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;With replacement=False, num_samples should not be specified, &#34;</span>
</span></span><span class=line><span class=cl>                             <span class=s2>&#34;since a random permute will be performed.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_samples</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>num_samples</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>data_source</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>num_samples</span><span class=p>,</span> <span class=nb>int</span><span class=p>)</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_samples</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;num_samples should be a positive integeral &#34;</span>
</span></span><span class=line><span class=cl>                             <span class=s2>&#34;value, but got num_samples=</span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>num_samples</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>replacement</span><span class=p>,</span> <span class=nb>bool</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;replacement should be a boolean value, but got &#34;</span>
</span></span><span class=line><span class=cl>                             <span class=s2>&#34;replacement=</span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>replacement</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>data_source</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>replacement</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>iter</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=n>high</span><span class=o>=</span><span class=n>n</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>num_samples</span><span class=p>,),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span><span class=o>.</span><span class=n>tolist</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>iter</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>randperm</span><span class=p>(</span><span class=n>n</span><span class=p>)</span><span class=o>.</span><span class=n>tolist</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>data_source</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>这个采样器常见的使用场景是将训练集划分成训练集和验证集:</p><div class=highlight id=id-10><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>SubsetRandomSampler</span><span class=p>(</span><span class=n>Sampler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># r&#34;&#34;&#34;Samples elements randomly from a given list of indices, without replacement.     # Arguments:     # indices (sequence): a sequence of indices     # &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>indices</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>indices</span> <span class=o>=</span> <span class=n>indices</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>indices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>torch</span><span class=o>.</span><span class=n>randperm</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>indices</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>indices</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p><strong>batch_sampler</strong>
前面的采样器每次都只返回一个索引，但是我们在训练时是对批量的数据进行训练，而这个工作就需要<code>BatchSampler</code>来做。也就是说<code>BatchSampler</code>的作用就是将前面的Sampler采样得到的索引值进行合并，当数量等于一个batch大小后就将这一批的索引值返回。</p><div class=highlight id=id-11><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>BatchSampler</span><span class=p>(</span><span class=n>Sampler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Wraps another sampler to yield a mini-batch of indices.     # Args:     # sampler (Sampler): Base sampler.     # batch_size (int): Size of mini-batch.     # drop_last (bool): If ``True``, the sampler will drop the last batch if     # its size would be less than ``batch_size``     # Example:     # &gt;&gt;&gt; list(BatchSampler(SequentialSampler(range(10)), batch_size=3, drop_last=False))     # [[0, 1, 2], [3, 4, 5], [6, 7, 8], [9]]     # &gt;&gt;&gt; list(BatchSampler(SequentialSampler(range(10)), batch_size=3, drop_last=True))     # [[0, 1, 2], [3, 4, 5], [6, 7, 8]]</span>
</span></span><span class=line><span class=cl><span class=c1># 批次采样     def __init__(self, sampler, batch_size, drop_last):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>sampler</span><span class=p>,</span> <span class=n>Sampler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;sampler should be an instance of &#34;</span>
</span></span><span class=line><span class=cl>                             <span class=s2>&#34;torch.utils.data.Sampler, but got sampler=</span><span class=si>{}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                             <span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>sampler</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>batch_size</span><span class=p>,</span> <span class=n>_int_classes</span><span class=p>)</span> <span class=ow>or</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>batch_size</span><span class=p>,</span> <span class=nb>bool</span><span class=p>)</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=n>batch_size</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;batch_size should be a positive integeral value, &#34;</span>
</span></span><span class=line><span class=cl>                             <span class=s2>&#34;but got batch_size=</span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>batch_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>drop_last</span><span class=p>,</span> <span class=nb>bool</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;drop_last should be a boolean value, but got &#34;</span>
</span></span><span class=line><span class=cl>                             <span class=s2>&#34;drop_last=</span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>drop_last</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sampler</span> <span class=o>=</span> <span class=n>sampler</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span> <span class=o>=</span> <span class=n>batch_size</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>drop_last</span> <span class=o>=</span> <span class=n>drop_last</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>batch</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>sampler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>batch</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>yield</span> <span class=n>batch</span>
</span></span><span class=line><span class=cl>                <span class=n>batch</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>drop_last</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>batch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>drop_last</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sampler</span><span class=p>)</span> <span class=o>//</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sampler</span><span class=p>)</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>//</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span></span></span></code></pre></td></tr></table></div></div><h3 id=多线程>多线程</h3><p><code>num_workers</code> 参数表示同时参与数据读取的线程数量，多线程技术可以加快数据读取，提供GPU/CPU利用率。</p><p>未来会出一篇文章讲一讲PyTorch多线程实现的原理。</p><h3 id=dataloader-和-dataset-简单举例>DataLoader 和 Dataset 简单举例</h3><div class=highlight id=id-12><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># construct dataset</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torch.utils.data</span> <span class=kn>import</span> <span class=n>Dataset</span><span class=p>,</span><span class=n>DataLoader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyDataset</span><span class=p>(</span><span class=n>Dataset</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>([[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>],[</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>],[</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>5</span><span class=p>],[</span><span class=mi>4</span><span class=p>,</span><span class=mi>5</span><span class=p>,</span><span class=mi>6</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>label</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>LongTensor</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=n>index</span><span class=p>],</span><span class=bp>self</span><span class=o>.</span><span class=n>label</span><span class=p>[</span><span class=n>index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># dataloader</span>
</span></span><span class=line><span class=cl><span class=n>mydataloader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>(</span><span class=n>dataset</span><span class=o>=</span><span class=n>mydataset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>batch_size</span> <span class=o>=</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>shuffle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>label</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>mydataloader</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>label</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><h2 id=demo1---mlps-dataset-and-dataloader>DEMO1 - MLP&rsquo;s Dataset and DataLoader</h2><div class=highlight id=id-13><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>dim_output</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TrainValidDataset</span><span class=p>(</span><span class=n>Dataset</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>    Args:
</span></span></span><span class=line><span class=cl><span class=s1>      - root_dir (string): Directory containing all folders with different
</span></span></span><span class=line><span class=cl><span class=s1>        dates, each folder containing .cruise.h5 data files.
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>list_of_files</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>list_of_files_</span> <span class=o>=</span> <span class=n>list_of_files</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_size_until_this_file_</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dataset_size</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>file</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>list_of_files_</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=n>h5py</span><span class=o>.</span><span class=n>File</span><span class=p>(</span><span class=n>file</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>h5_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data_size</span> <span class=o>=</span> <span class=n>h5_file</span><span class=p>[</span><span class=nb>list</span><span class=p>(</span><span class=n>h5_file</span><span class=o>.</span><span class=n>keys</span><span class=p>())[</span><span class=mi>0</span><span class=p>]]</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>dataset_size</span> <span class=o>+=</span> <span class=n>data_size</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>data_size_until_this_file_</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dataset_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=p>(</span><span class=s1>&#39;Total size of dataset: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>data_size_until_this_file_</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>dataset_size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>bin_idx</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>FindBin</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>data_size_until_this_file_</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>h5py</span><span class=o>.</span><span class=n>File</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>list_of_files_</span><span class=p>[</span><span class=n>bin_idx</span><span class=p>],</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>h5_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>idx_offset</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>data_size_until_this_file_</span><span class=p>[</span><span class=n>bin_idx</span><span class=p>]</span> <span class=o>-</span> \
</span></span><span class=line><span class=cl>                <span class=n>h5_file</span><span class=p>[</span><span class=nb>list</span><span class=p>(</span><span class=n>h5_file</span><span class=o>.</span><span class=n>keys</span><span class=p>())[</span><span class=mi>0</span><span class=p>]]</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>h5_file</span><span class=p>[</span><span class=nb>list</span><span class=p>(</span><span class=n>h5_file</span><span class=o>.</span><span class=n>keys</span><span class=p>())[</span><span class=mi>0</span><span class=p>]][</span><span class=n>index</span><span class=o>-</span><span class=n>idx_offset</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>label</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=o>-</span><span class=n>dim_output</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=n>label</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>label</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mf>0.0</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>float</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span><span class=p>[:</span><span class=o>-</span><span class=n>dim_output</span><span class=p>],</span> <span class=n>label</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Binary search to expedite the data-loading process.</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>FindBin</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>index</span><span class=p>,</span> <span class=n>start</span><span class=p>,</span> <span class=n>end</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>start</span> <span class=o>==</span> <span class=n>end</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>mid</span> <span class=o>=</span> <span class=nb>int</span><span class=p>((</span><span class=n>start</span><span class=o>+</span><span class=n>end</span><span class=p>)</span><span class=o>/</span><span class=mf>2.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>data_size_until_this_file_</span><span class=p>[</span><span class=n>mid</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>FindBin</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>mid</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=n>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>FindBin</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>start</span><span class=p>,</span> <span class=n>mid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># search all the files in the directory</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>getListOfFiles</span><span class=p>(</span><span class=n>dirName</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>listOfFiles</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>listdir</span><span class=p>(</span><span class=n>dirName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>allFiles</span> <span class=o>=</span> <span class=nb>list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=n>listOfFiles</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>fullPath</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>dirName</span><span class=p>,</span> <span class=n>entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isdir</span><span class=p>(</span><span class=n>fullPath</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>allFiles</span> <span class=o>=</span> <span class=n>allFiles</span> <span class=o>+</span> <span class=n>getListOfFiles</span><span class=p>(</span><span class=n>fullPath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>allFiles</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>fullPath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>allFiles</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>list_of_training_files</span> <span class=o>=</span> <span class=n>getListOfFiles</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>train_dataset</span> <span class=o>=</span> <span class=n>TrainValidDataset</span><span class=p>(</span><span class=n>list_of_training_files</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>myDataLoader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>(</span><span class=n>dataset</span><span class=o>=</span><span class=n>train_dataset</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>drop_last</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>shuffle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>label</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>myDataLoader</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><h2 id=demo2---lanegcns-dataset-and-dataloader>DEMO2 - LaneGCN&rsquo;s Dataset and DataLoader</h2><p><strong>dataset description:</strong></p><div class=highlight id=id-14><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ArgoDataset</span><span class=p>(</span><span class=n>Dataset</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>split</span><span class=p>,</span> <span class=n>config</span><span class=p>,</span> <span class=n>train</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>config</span> <span class=o>=</span> <span class=n>config</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>train</span> <span class=o>=</span> <span class=n>train</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;preprocess&#39;</span> <span class=ow>in</span> <span class=n>config</span> <span class=ow>and</span> <span class=n>config</span><span class=p>[</span><span class=s1>&#39;preprocess&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>train</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>split</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;preprocess_train&#39;</span><span class=p>],</span> <span class=n>allow_pickle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>split</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;preprocess_val&#39;</span><span class=p>],</span> <span class=n>allow_pickle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>avl</span> <span class=o>=</span> <span class=n>ArgoverseForecastingLoader</span><span class=p>(</span><span class=n>split</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>avl</span><span class=o>.</span><span class=n>seq_list</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>avl</span><span class=o>.</span><span class=n>seq_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>am</span> <span class=o>=</span> <span class=n>ArgoverseMap</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;raster&#39;</span> <span class=ow>in</span> <span class=n>config</span> <span class=ow>and</span> <span class=n>config</span><span class=p>[</span><span class=s1>&#39;raster&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=c1>#TODO: DELETE</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>map_query</span> <span class=o>=</span> <span class=n>MapQuery</span><span class=p>(</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;map_scale&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;preprocess&#39;</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;preprocess&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>split</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>train</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;rot_aug&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>new_data</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>,</span> <span class=s1>&#39;orig&#39;</span><span class=p>,</span> <span class=s1>&#39;gt_preds&#39;</span><span class=p>,</span> <span class=s1>&#39;has_preds&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>new_data</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>ref_copy</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>key</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>dt</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;rot_size&#39;</span><span class=p>]</span><span class=c1>#np.pi * 2.0</span>
</span></span><span class=line><span class=cl>                <span class=n>theta</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;theta&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>dt</span>
</span></span><span class=line><span class=cl>                <span class=n>new_data</span><span class=p>[</span><span class=s1>&#39;theta&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>theta</span>
</span></span><span class=line><span class=cl>                <span class=n>new_data</span><span class=p>[</span><span class=s1>&#39;rot&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>([</span>
</span></span><span class=line><span class=cl>                    <span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=n>theta</span><span class=p>),</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=n>theta</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>                    <span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=n>theta</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=n>theta</span><span class=p>)]],</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>rot</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>([</span>
</span></span><span class=line><span class=cl>                    <span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=o>-</span><span class=n>dt</span><span class=p>),</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=o>-</span><span class=n>dt</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>                    <span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=o>-</span><span class=n>dt</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=o>-</span><span class=n>dt</span><span class=p>)]],</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>new_data</span><span class=p>[</span><span class=s1>&#39;feats&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;feats&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>new_data</span><span class=p>[</span><span class=s1>&#39;feats&#39;</span><span class=p>][:,</span> <span class=p>:,</span> <span class=p>:</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>new_data</span><span class=p>[</span><span class=s1>&#39;feats&#39;</span><span class=p>][:,</span> <span class=p>:,</span> <span class=p>:</span><span class=mi>2</span><span class=p>],</span> <span class=n>rot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>new_data</span><span class=p>[</span><span class=s1>&#39;ctrs&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;ctrs&#39;</span><span class=p>],</span> <span class=n>rot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>graph</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;num_nodes&#39;</span><span class=p>,</span> <span class=s1>&#39;turn&#39;</span><span class=p>,</span> <span class=s1>&#39;control&#39;</span><span class=p>,</span> <span class=s1>&#39;intersect&#39;</span><span class=p>,</span> <span class=s1>&#39;pre&#39;</span><span class=p>,</span> <span class=s1>&#39;suc&#39;</span><span class=p>,</span> <span class=s1>&#39;lane_idcs&#39;</span><span class=p>,</span> <span class=s1>&#39;left_pairs&#39;</span><span class=p>,</span> <span class=s1>&#39;right_pairs&#39;</span><span class=p>,</span> <span class=s1>&#39;left&#39;</span><span class=p>,</span> <span class=s1>&#39;right&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>graph</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>ref_copy</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;graph&#39;</span><span class=p>][</span><span class=n>key</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;ctrs&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;graph&#39;</span><span class=p>][</span><span class=s1>&#39;ctrs&#39;</span><span class=p>],</span> <span class=n>rot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;feats&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;graph&#39;</span><span class=p>][</span><span class=s1>&#39;feats&#39;</span><span class=p>],</span> <span class=n>rot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>new_data</span><span class=p>[</span><span class=s1>&#39;graph&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>graph</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>new_data</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>new_data</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>,</span> <span class=s1>&#39;orig&#39;</span><span class=p>,</span> <span class=s1>&#39;gt_preds&#39;</span><span class=p>,</span> <span class=s1>&#39;has_preds&#39;</span><span class=p>,</span> <span class=s1>&#39;theta&#39;</span><span class=p>,</span> <span class=s1>&#39;rot&#39;</span><span class=p>,</span> <span class=s1>&#39;feats&#39;</span><span class=p>,</span> <span class=s1>&#39;ctrs&#39;</span><span class=p>,</span> <span class=s1>&#39;graph&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>new_data</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>ref_copy</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>key</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>new_data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;raster&#39;</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;raster&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;graph&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>x_min</span><span class=p>,</span> <span class=n>x_max</span><span class=p>,</span> <span class=n>y_min</span><span class=p>,</span> <span class=n>y_max</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;pred_range&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>cx</span><span class=p>,</span> <span class=n>cy</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;orig&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>region</span> <span class=o>=</span> <span class=p>[</span><span class=n>cx</span> <span class=o>+</span> <span class=n>x_min</span><span class=p>,</span> <span class=n>cx</span> <span class=o>+</span> <span class=n>x_max</span><span class=p>,</span> <span class=n>cy</span> <span class=o>+</span> <span class=n>y_min</span><span class=p>,</span> <span class=n>cy</span> <span class=o>+</span> <span class=n>y_max</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>raster</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>map_query</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>region</span><span class=p>,</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;theta&#39;</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=p>[</span><span class=s1>&#39;raster&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>raster</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_argo_data</span><span class=p>(</span><span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_obj_feats</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;idx&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>idx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;raster&#39;</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;raster&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>x_min</span><span class=p>,</span> <span class=n>x_max</span><span class=p>,</span> <span class=n>y_min</span><span class=p>,</span> <span class=n>y_max</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;pred_range&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>cx</span><span class=p>,</span> <span class=n>cy</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;orig&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>region</span> <span class=o>=</span> <span class=p>[</span><span class=n>cx</span> <span class=o>+</span> <span class=n>x_min</span><span class=p>,</span> <span class=n>cx</span> <span class=o>+</span> <span class=n>x_max</span><span class=p>,</span> <span class=n>cy</span> <span class=o>+</span> <span class=n>y_min</span><span class=p>,</span> <span class=n>cy</span> <span class=o>+</span> <span class=n>y_max</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>raster</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>map_query</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>region</span><span class=p>,</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;theta&#39;</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;raster&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>raster</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;graph&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_lane_graph</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;preprocess&#39;</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;preprocess&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>split</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>avl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>read_argo_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>city</span> <span class=o>=</span> <span class=n>copy</span><span class=o>.</span><span class=n>deepcopy</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>avl</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span><span class=o>.</span><span class=n>city</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;TIMESTAMP,TRACK_ID,OBJECT_TYPE,X,Y,CITY_NAME&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>copy</span><span class=o>.</span><span class=n>deepcopy</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>avl</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span><span class=o>.</span><span class=n>seq_df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>agt_ts</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>unique</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;TIMESTAMP&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>mapping</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>ts</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>agt_ts</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>mapping</span><span class=p>[</span><span class=n>ts</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>trajs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>((</span>
</span></span><span class=line><span class=cl>            <span class=n>df</span><span class=o>.</span><span class=n>X</span><span class=o>.</span><span class=n>to_numpy</span><span class=p>()</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>df</span><span class=o>.</span><span class=n>Y</span><span class=o>.</span><span class=n>to_numpy</span><span class=p>()</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)),</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>steps</span> <span class=o>=</span> <span class=p>[</span><span class=n>mapping</span><span class=p>[</span><span class=n>x</span><span class=p>]</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;TIMESTAMP&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>steps</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>steps</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>objs</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>groupby</span><span class=p>([</span><span class=s1>&#39;TRACK_ID&#39;</span><span class=p>,</span> <span class=s1>&#39;OBJECT_TYPE&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>groups</span>
</span></span><span class=line><span class=cl>        <span class=n>keys</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>objs</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>obj_type</span> <span class=o>=</span> <span class=p>[</span><span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>keys</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>agt_idx</span> <span class=o>=</span> <span class=n>obj_type</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s1>&#39;AGENT&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>idcs</span> <span class=o>=</span> <span class=n>objs</span><span class=p>[</span><span class=n>keys</span><span class=p>[</span><span class=n>agt_idx</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>agt_traj</span> <span class=o>=</span> <span class=n>trajs</span><span class=p>[</span><span class=n>idcs</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>agt_step</span> <span class=o>=</span> <span class=n>steps</span><span class=p>[</span><span class=n>idcs</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>del</span> <span class=n>keys</span><span class=p>[</span><span class=n>agt_idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx_trajs</span><span class=p>,</span> <span class=n>ctx_steps</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>idcs</span> <span class=o>=</span> <span class=n>objs</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx_trajs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>trajs</span><span class=p>[</span><span class=n>idcs</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx_steps</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>steps</span><span class=p>[</span><span class=n>idcs</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>city</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;trajs&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>agt_traj</span><span class=p>]</span> <span class=o>+</span> <span class=n>ctx_trajs</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;steps&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>agt_step</span><span class=p>]</span> <span class=o>+</span> <span class=n>ctx_steps</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_obj_feats</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>orig</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;trajs&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=mi>19</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>train</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;rot_aug&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>theta</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>pi</span> <span class=o>*</span> <span class=mf>2.0</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>pre</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;trajs&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=mi>18</span><span class=p>]</span> <span class=o>-</span> <span class=n>orig</span>
</span></span><span class=line><span class=cl>            <span class=n>theta</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>pi</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>arctan2</span><span class=p>(</span><span class=n>pre</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>pre</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>rot</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>([</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=n>theta</span><span class=p>),</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=n>theta</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=n>theta</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=n>theta</span><span class=p>)]],</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>feats</span><span class=p>,</span> <span class=n>ctrs</span><span class=p>,</span> <span class=n>gt_preds</span><span class=p>,</span> <span class=n>has_preds</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[],</span> <span class=p>[],</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>traj</span><span class=p>,</span> <span class=n>step</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;trajs&#39;</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;steps&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=mi>19</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>step</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>gt_pred</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=mi>30</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>has_pred</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>future_mask</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>logical_and</span><span class=p>(</span><span class=n>step</span> <span class=o>&gt;=</span> <span class=mi>20</span><span class=p>,</span> <span class=n>step</span> <span class=o>&lt;</span> <span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>post_step</span> <span class=o>=</span> <span class=n>step</span><span class=p>[</span><span class=n>future_mask</span><span class=p>]</span> <span class=o>-</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>            <span class=n>post_traj</span> <span class=o>=</span> <span class=n>traj</span><span class=p>[</span><span class=n>future_mask</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>gt_pred</span><span class=p>[</span><span class=n>post_step</span><span class=p>]</span> <span class=o>=</span> <span class=n>post_traj</span>
</span></span><span class=line><span class=cl>            <span class=n>has_pred</span><span class=p>[</span><span class=n>post_step</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>obs_mask</span> <span class=o>=</span> <span class=n>step</span> <span class=o>&lt;</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>            <span class=n>step</span> <span class=o>=</span> <span class=n>step</span><span class=p>[</span><span class=n>obs_mask</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>traj</span> <span class=o>=</span> <span class=n>traj</span><span class=p>[</span><span class=n>obs_mask</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>idcs</span> <span class=o>=</span> <span class=n>step</span><span class=o>.</span><span class=n>argsort</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>step</span> <span class=o>=</span> <span class=n>step</span><span class=p>[</span><span class=n>idcs</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>traj</span> <span class=o>=</span> <span class=n>traj</span><span class=p>[</span><span class=n>idcs</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>step</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>step</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=mi>19</span> <span class=o>-</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>step</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>i</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=n>step</span> <span class=o>=</span> <span class=n>step</span><span class=p>[</span><span class=n>i</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>            <span class=n>traj</span> <span class=o>=</span> <span class=n>traj</span><span class=p>[</span><span class=n>i</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>feat</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=mi>20</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>feat</span><span class=p>[</span><span class=n>step</span><span class=p>,</span> <span class=p>:</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>rot</span><span class=p>,</span> <span class=p>(</span><span class=n>traj</span> <span class=o>-</span> <span class=n>orig</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span><span class=o>.</span><span class=n>T</span><span class=p>)</span><span class=o>.</span><span class=n>T</span>
</span></span><span class=line><span class=cl>            <span class=n>feat</span><span class=p>[</span><span class=n>step</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>x_min</span><span class=p>,</span> <span class=n>x_max</span><span class=p>,</span> <span class=n>y_min</span><span class=p>,</span> <span class=n>y_max</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;pred_range&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>feat</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>x_min</span> <span class=ow>or</span> <span class=n>feat</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>x_max</span> <span class=ow>or</span> <span class=n>feat</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>y_min</span> <span class=ow>or</span> <span class=n>feat</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>y_max</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>ctrs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>feat</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>:</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>feat</span><span class=p>[</span><span class=mi>1</span><span class=p>:,</span> <span class=p>:</span><span class=mi>2</span><span class=p>]</span> <span class=o>-=</span> <span class=n>feat</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>:</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>feat</span><span class=p>[</span><span class=n>step</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=p>:</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=n>feats</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>feat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>gt_preds</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>gt_pred</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>has_preds</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>has_pred</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>feats</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>feats</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ctrs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>ctrs</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>gt_preds</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>gt_preds</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>has_preds</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>has_preds</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;feats&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>feats</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;ctrs&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>ctrs</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;orig&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>orig</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;theta&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>theta</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;rot&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>rot</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;gt_preds&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>gt_preds</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;has_preds&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>has_preds</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_lane_graph</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Get a rectangle area defined by pred_range.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>x_min</span><span class=p>,</span> <span class=n>x_max</span><span class=p>,</span> <span class=n>y_min</span><span class=p>,</span> <span class=n>y_max</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;pred_range&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>radius</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>x_min</span><span class=p>),</span> <span class=nb>abs</span><span class=p>(</span><span class=n>x_max</span><span class=p>))</span> <span class=o>+</span> <span class=nb>max</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>y_min</span><span class=p>),</span> <span class=nb>abs</span><span class=p>(</span><span class=n>y_max</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>lane_ids</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>am</span><span class=o>.</span><span class=n>get_lane_ids_in_xy_bbox</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;orig&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;orig&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>],</span> <span class=n>radius</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>lane_ids</span> <span class=o>=</span> <span class=n>copy</span><span class=o>.</span><span class=n>deepcopy</span><span class=p>(</span><span class=n>lane_ids</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>lanes</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>lane_id</span> <span class=ow>in</span> <span class=n>lane_ids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>lane</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>am</span><span class=o>.</span><span class=n>city_lane_centerlines_dict</span><span class=p>[</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>]][</span><span class=n>lane_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>lane</span> <span class=o>=</span> <span class=n>copy</span><span class=o>.</span><span class=n>deepcopy</span><span class=p>(</span><span class=n>lane</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>centerline</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;rot&#39;</span><span class=p>],</span> <span class=p>(</span><span class=n>lane</span><span class=o>.</span><span class=n>centerline</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;orig&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span><span class=o>.</span><span class=n>T</span><span class=p>)</span><span class=o>.</span><span class=n>T</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>centerline</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>centerline</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>x</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>&lt;</span> <span class=n>x_min</span> <span class=ow>or</span> <span class=n>x</span><span class=o>.</span><span class=n>min</span><span class=p>()</span> <span class=o>&gt;</span> <span class=n>x_max</span> <span class=ow>or</span> <span class=n>y</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>&lt;</span> <span class=n>y_min</span> <span class=ow>or</span> <span class=n>y</span><span class=o>.</span><span class=n>min</span><span class=p>()</span> <span class=o>&gt;</span> <span class=n>y_max</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;&#34;&#34;Getting polygons requires original centerline&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>polygon</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>am</span><span class=o>.</span><span class=n>get_lane_segment_polygon</span><span class=p>(</span><span class=n>lane_id</span><span class=p>,</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>polygon</span> <span class=o>=</span> <span class=n>copy</span><span class=o>.</span><span class=n>deepcopy</span><span class=p>(</span><span class=n>polygon</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>lane</span><span class=o>.</span><span class=n>centerline</span> <span class=o>=</span> <span class=n>centerline</span>
</span></span><span class=line><span class=cl>                <span class=n>lane</span><span class=o>.</span><span class=n>polygon</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;rot&#39;</span><span class=p>],</span> <span class=p>(</span><span class=n>polygon</span><span class=p>[:,</span> <span class=p>:</span><span class=mi>2</span><span class=p>]</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;orig&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span><span class=o>.</span><span class=n>T</span><span class=p>)</span><span class=o>.</span><span class=n>T</span>
</span></span><span class=line><span class=cl>                <span class=n>lanes</span><span class=p>[</span><span class=n>lane_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>lane</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>lane_ids</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>lanes</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>ctrs</span><span class=p>,</span> <span class=n>feats</span><span class=p>,</span> <span class=n>turn</span><span class=p>,</span> <span class=n>control</span><span class=p>,</span> <span class=n>intersect</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[],</span> <span class=p>[],</span> <span class=p>[],</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>lane_id</span> <span class=ow>in</span> <span class=n>lane_ids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>lane</span> <span class=o>=</span> <span class=n>lanes</span><span class=p>[</span><span class=n>lane_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>ctrln</span> <span class=o>=</span> <span class=n>lane</span><span class=o>.</span><span class=n>centerline</span>
</span></span><span class=line><span class=cl>            <span class=n>num_segs</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>ctrln</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>ctrs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>((</span><span class=n>ctrln</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>ctrln</span><span class=p>[</span><span class=mi>1</span><span class=p>:])</span> <span class=o>/</span> <span class=mf>2.0</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>feats</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>ctrln</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span> <span class=o>-</span> <span class=n>ctrln</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>num_segs</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>lane</span><span class=o>.</span><span class=n>turn_direction</span> <span class=o>==</span> <span class=s1>&#39;LEFT&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>x</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>lane</span><span class=o>.</span><span class=n>turn_direction</span> <span class=o>==</span> <span class=s1>&#39;RIGHT&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>x</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>            <span class=n>turn</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>control</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>lane</span><span class=o>.</span><span class=n>has_traffic_control</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>num_segs</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>intersect</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>lane</span><span class=o>.</span><span class=n>is_intersection</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>num_segs</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>node_idcs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>ctr</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>ctrs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>node_idcs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>count</span><span class=p>,</span> <span class=n>count</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>ctr</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            <span class=n>count</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=n>ctr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>num_nodes</span> <span class=o>=</span> <span class=n>count</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pre</span><span class=p>,</span> <span class=n>suc</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(),</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>,</span> <span class=s1>&#39;v&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>pre</span><span class=p>[</span><span class=n>key</span><span class=p>],</span> <span class=n>suc</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>lane_id</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>lane_ids</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>lane</span> <span class=o>=</span> <span class=n>lanes</span><span class=p>[</span><span class=n>lane_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>idcs</span> <span class=o>=</span> <span class=n>node_idcs</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>pre</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>idcs</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>            <span class=n>pre</span><span class=p>[</span><span class=s1>&#39;v&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>idcs</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>lane</span><span class=o>.</span><span class=n>predecessors</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>nbr_id</span> <span class=ow>in</span> <span class=n>lane</span><span class=o>.</span><span class=n>predecessors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>nbr_id</span> <span class=ow>in</span> <span class=n>lane_ids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>j</span> <span class=o>=</span> <span class=n>lane_ids</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>nbr_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>pre</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>idcs</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                        <span class=n>pre</span><span class=p>[</span><span class=s1>&#39;v&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>node_idcs</span><span class=p>[</span><span class=n>j</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>suc</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>idcs</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>suc</span><span class=p>[</span><span class=s1>&#39;v&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>idcs</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>lane</span><span class=o>.</span><span class=n>successors</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>nbr_id</span> <span class=ow>in</span> <span class=n>lane</span><span class=o>.</span><span class=n>successors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>nbr_id</span> <span class=ow>in</span> <span class=n>lane_ids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>j</span> <span class=o>=</span> <span class=n>lane_ids</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>nbr_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>suc</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>idcs</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                        <span class=n>suc</span><span class=p>[</span><span class=s1>&#39;v&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>node_idcs</span><span class=p>[</span><span class=n>j</span><span class=p>][</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>lane_idcs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>idcs</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>node_idcs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>lane_idcs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>i</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>idcs</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>lane_idcs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>lane_idcs</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pre_pairs</span><span class=p>,</span> <span class=n>suc_pairs</span><span class=p>,</span> <span class=n>left_pairs</span><span class=p>,</span> <span class=n>right_pairs</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[],</span> <span class=p>[],</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>lane_id</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>lane_ids</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>lane</span> <span class=o>=</span> <span class=n>lanes</span><span class=p>[</span><span class=n>lane_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>nbr_ids</span> <span class=o>=</span> <span class=n>lane</span><span class=o>.</span><span class=n>predecessors</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>nbr_ids</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>nbr_id</span> <span class=ow>in</span> <span class=n>nbr_ids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>nbr_id</span> <span class=ow>in</span> <span class=n>lane_ids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>j</span> <span class=o>=</span> <span class=n>lane_ids</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>nbr_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>pre_pairs</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>nbr_ids</span> <span class=o>=</span> <span class=n>lane</span><span class=o>.</span><span class=n>successors</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>nbr_ids</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>nbr_id</span> <span class=ow>in</span> <span class=n>nbr_ids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>nbr_id</span> <span class=ow>in</span> <span class=n>lane_ids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>j</span> <span class=o>=</span> <span class=n>lane_ids</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>nbr_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>suc_pairs</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>nbr_id</span> <span class=o>=</span> <span class=n>lane</span><span class=o>.</span><span class=n>l_neighbor_id</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>nbr_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>nbr_id</span> <span class=ow>in</span> <span class=n>lane_ids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>j</span> <span class=o>=</span> <span class=n>lane_ids</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>nbr_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>left_pairs</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>nbr_id</span> <span class=o>=</span> <span class=n>lane</span><span class=o>.</span><span class=n>r_neighbor_id</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>nbr_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>nbr_id</span> <span class=ow>in</span> <span class=n>lane_ids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>j</span> <span class=o>=</span> <span class=n>lane_ids</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>nbr_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>right_pairs</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>pre_pairs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>pre_pairs</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>suc_pairs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>suc_pairs</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>left_pairs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>left_pairs</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>right_pairs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>right_pairs</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>graph</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;ctrs&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>ctrs</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;num_nodes&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>num_nodes</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;feats&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>feats</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;turn&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>turn</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;control&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;intersect&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>intersect</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;pre&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>pre</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;suc&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>suc</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;lane_idcs&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>lane_idcs</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;pre_pairs&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pre_pairs</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;suc_pairs&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>suc_pairs</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;left_pairs&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>left_pairs</span>
</span></span><span class=line><span class=cl>        <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;right_pairs&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>right_pairs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>k1</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;pre&#39;</span><span class=p>,</span> <span class=s1>&#39;suc&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>k2</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>,</span> <span class=s1>&#39;v&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>graph</span><span class=p>[</span><span class=n>k1</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=n>k2</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>graph</span><span class=p>[</span><span class=n>k1</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=n>k2</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;pre&#39;</span><span class=p>,</span> <span class=s1>&#39;suc&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;scales&#39;</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;scales&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=c1>#TODO: delete here</span>
</span></span><span class=line><span class=cl>                <span class=n>graph</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>+=</span> <span class=n>dilated_nbrs2</span><span class=p>(</span><span class=n>graph</span><span class=p>[</span><span class=n>key</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;num_nodes&#39;</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;scales&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>graph</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>+=</span> <span class=n>dilated_nbrs</span><span class=p>(</span><span class=n>graph</span><span class=p>[</span><span class=n>key</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>graph</span><span class=p>[</span><span class=s1>&#39;num_nodes&#39;</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;num_scales&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>graph</span></span></span></code></pre></td></tr></table></div></div><p><strong>DataLoader:</strong></p><div class=highlight id=id-15><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl> <span class=c1># Data loader for training</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset</span> <span class=o>=</span> <span class=n>Dataset</span><span class=p>(</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;train_split&#34;</span><span class=p>],</span> <span class=n>config</span><span class=p>,</span> <span class=n>train</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>train_sampler</span> <span class=o>=</span> <span class=n>DistributedSampler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset</span><span class=p>,</span> <span class=n>num_replicas</span><span class=o>=</span><span class=n>hvd</span><span class=o>.</span><span class=n>size</span><span class=p>(),</span> <span class=n>rank</span><span class=o>=</span><span class=n>hvd</span><span class=o>.</span><span class=n>rank</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>train_loader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>batch_size</span><span class=o>=</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;batch_size&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>num_workers</span><span class=o>=</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;workers&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>sampler</span><span class=o>=</span><span class=n>train_sampler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>collate_fn</span><span class=o>=</span><span class=n>collate_fn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>pin_memory</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>worker_init_fn</span><span class=o>=</span><span class=n>worker_init_fn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>drop_last</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Data loader for evaluation</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset</span> <span class=o>=</span> <span class=n>Dataset</span><span class=p>(</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;val_split&#34;</span><span class=p>],</span> <span class=n>config</span><span class=p>,</span> <span class=n>train</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>val_sampler</span> <span class=o>=</span> <span class=n>DistributedSampler</span><span class=p>(</span><span class=n>dataset</span><span class=p>,</span> <span class=n>num_replicas</span><span class=o>=</span><span class=n>hvd</span><span class=o>.</span><span class=n>size</span><span class=p>(),</span> <span class=n>rank</span><span class=o>=</span><span class=n>hvd</span><span class=o>.</span><span class=n>rank</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>val_loader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>batch_size</span><span class=o>=</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;val_batch_size&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>num_workers</span><span class=o>=</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;val_workers&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>sampler</span><span class=o>=</span><span class=n>val_sampler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>collate_fn</span><span class=o>=</span><span class=n>collate_fn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>pin_memory</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div><div class=post-reward><div class=comment>Buy me a coffee~</div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward>赞赏</label><div class=reward-ways data-mode=fixed><div><img loading=lazy src=/images/alipay.png srcset="/images/alipay.png, /images/alipay.png 1.5x, /images/alipay.png 2x" sizes=auto data-title="Jian YE 支付宝" data-alt="Jian YE 支付宝" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span data-animation>支付宝</span></div><div><img loading=lazy src=/images/wechatpay.png srcset="/images/wechatpay.png, /images/wechatpay.png 1.5x, /images/wechatpay.png 2x" sizes=auto data-title="Jian YE 微信" data-alt="Jian YE 微信" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span data-animation>微信</span></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-07-15 18:58:05">更新于 2023-07-15&nbsp;<a class=git-hash href=https://github.com/jianye0428/JianBlog/commit/0c96c3ed998b4982a84dc515a44d8afab4a795b6 rel="external nofollow noopener noreferrer" target=_blank title="commit by yejian(yejian@zhito.com) 0c96c3ed998b4982a84dc515a44d8afab4a795b6: feat: add PyTorch Notes"><i class="fa-solid fa-hashtag fa-fw" aria-hidden=true></i>0c96c3e</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/datasetanddataloader/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span><span><a href=https://github.com/jianye0428/JianBlog/edit/docs/content/posts/PyTorch/DatasetAndDataLoader/index.md title=编辑此页 target=_blank rel="external nofollow noopener noreferrer" class=link-to-edit>编辑此页</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://jianye0428.github.io/posts/datasetanddataloader/ data-title="PyTorch Dataset And DataLoader" data-hashtags=draft><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://jianye0428.github.io/posts/datasetanddataloader/ data-hashtag=draft><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://jianye0428.github.io/posts/datasetanddataloader/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://jianye0428.github.io/posts/datasetanddataloader/ data-title="PyTorch Dataset And DataLoader"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://jianye0428.github.io/posts/datasetanddataloader/ data-title="PyTorch Dataset And DataLoader"><i data-svg-src=/lib/simple-icons/icons/baidu.min.svg aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/draft/ class=post-tag>draft</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/pytorchnotes/ class=post-nav-item rel=prev title="PyTorch Notes"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>PyTorch Notes</a>
<a href=/posts/pythonnotes1/ class=post-nav-item rel=next title="Python Notes 1">Python Notes 1<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=jianye0428/JianBlog data-repo-id=R_kgDOJ4kgoQ data-category=General data-category-id=DIC_kwDOJ4kgoc4CX7CO data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.117.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/jianye0428 target=_blank rel="external nofollow noopener noreferrer">Jian YE</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics order-first"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="ms-1 d-none">博客已运行</span><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/jianye0428/JianBlog title="在 GitHub 上查看程式碼，訂閱請點 Watch" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:#000;--bg-progress-dark:#fff></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script src=/lib/instant-page/instantpage.min.js async defer type=module></script><script src=/lib/twemoji/twemoji.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=/lib/cell-watermark/watermark.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:50},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark_dimmed",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{algoliaAppID:"MTJNHU0JVB",algoliaIndex:"index",algoliaSearchKey:"5486225134d99f43826da401ee9bad57",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},siteTime:"2018-05-28T20:01:01+08:00",twemoji:!0,watermark:{appendto:".wrapper>main",colspacing:30,content:'<img style="height: 0.85rem;" src="/images/favicon/jian_icon.png" alt="logo" /> jianye',enable:!0,fontfamily:"MMT_LRH,沐目体",fontsize:1.1,height:20,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script></body></html>