<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>深度学习分布式训练框架 horovod[3] -- Horovodrun背后做了什么 - yejian's blog</title><meta name=author content="Jian YE">
<meta name=author-link content="https://github.com/jianye0428"><meta name=description content="references: [1]. https://www.cnblogs.com/rossiXYZ/p/14881812.html 0 摘要 Horovod 是Uber于2017年发布的一个易于使用的高性能的分布式训练框架，在业界得到了广泛应用。 本系列将通过源码分析来带领大家了解 Horovod。本文是系列第三篇，从 python 开始进入 Horovod 世界，看看 Horovodrun 做了什么。 前两篇链接如下： 深度学习分布式训练框架 Horovod (1) &mdash; 基础知识 深度学习分布式训练框架 horovod (2) &mdash; 从使用者角度切"><meta name=keywords content="Horovod"><meta itemprop=name content="深度学习分布式训练框架 horovod[3] -- Horovodrun背后做了什么"><meta itemprop=description content="references: [1]. https://www.cnblogs.com/rossiXYZ/p/14881812.html 0 摘要 Horovod 是Uber于2017年发布的一个易于使用的高性能的分布式训练框架，在业界得到了广泛应用。 本系列将通过源码分析来带领大家了解 Horovod。本文是系列第三篇，从 python 开始进入 Horovod 世界，看看 Horovodrun 做了什么。 前两篇链接如下： 深度学习分布式训练框架 Horovod (1) &mdash; 基础知识 深度学习分布式训练框架 horovod (2) &mdash; 从使用者角度切"><meta itemprop=datePublished content="2023-07-10T07:53:45+08:00"><meta itemprop=dateModified content="2023-07-15T15:28:35+08:00"><meta itemprop=wordCount content="10894"><meta itemprop=image content="https://jianye0428.github.io/images/favicon/jian_icon.png"><meta itemprop=keywords content="Horovod,"><meta property="og:title" content="深度学习分布式训练框架 horovod[3] -- Horovodrun背后做了什么"><meta property="og:description" content="references: [1]. https://www.cnblogs.com/rossiXYZ/p/14881812.html 0 摘要 Horovod 是Uber于2017年发布的一个易于使用的高性能的分布式训练框架，在业界得到了广泛应用。 本系列将通过源码分析来带领大家了解 Horovod。本文是系列第三篇，从 python 开始进入 Horovod 世界，看看 Horovodrun 做了什么。 前两篇链接如下： 深度学习分布式训练框架 Horovod (1) &mdash; 基础知识 深度学习分布式训练框架 horovod (2) &mdash; 从使用者角度切"><meta property="og:type" content="article"><meta property="og:url" content="https://jianye0428.github.io/posts/2022-10-08_horovod_3/"><meta property="og:image" content="https://jianye0428.github.io/images/favicon/jian_icon.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-10T07:53:45+08:00"><meta property="article:modified_time" content="2023-07-15T15:28:35+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jianye0428.github.io/images/favicon/jian_icon.png"><meta name=twitter:title content="深度学习分布式训练框架 horovod[3] -- Horovodrun背后做了什么"><meta name=twitter:description content="references: [1]. https://www.cnblogs.com/rossiXYZ/p/14881812.html 0 摘要 Horovod 是Uber于2017年发布的一个易于使用的高性能的分布式训练框架，在业界得到了广泛应用。 本系列将通过源码分析来带领大家了解 Horovod。本文是系列第三篇，从 python 开始进入 Horovod 世界，看看 Horovodrun 做了什么。 前两篇链接如下： 深度学习分布式训练框架 Horovod (1) &mdash; 基础知识 深度学习分布式训练框架 horovod (2) &mdash; 从使用者角度切"><meta name=application-name content="菠菜阿九时代峰峻啊；数量可根据；"><meta name=apple-mobile-web-app-title content="菠菜阿九时代峰峻啊；数量可根据；"><meta name=theme-color data-light=#ffffff data-dark=#252627 content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/png href=/jian_icon.png><link rel=icon type=image/png sizes=32x32 href=/jian_icon.png><link rel=icon type=image/png sizes=16x16 href=/jian_icon.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://jianye0428.github.io/posts/2022-10-08_horovod_3/><link rel=prev href=https://jianye0428.github.io/posts/2022-10-08_horovod_2/><link rel=next href=https://jianye0428.github.io/posts/2022-10-08_horovod_4/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"深度学习分布式训练框架 horovod[3] -- Horovodrun背后做了什么","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/jianye0428.github.io\/posts\/2022-10-08_horovod_3\/"},"image":["https:\/\/jianye0428.github.io\/images\/favicon\/jian_icon.png"],"genre":"posts","keywords":"Horovod","wordcount":10894,"url":"https:\/\/jianye0428.github.io\/posts\/2022-10-08_horovod_3\/","datePublished":"2023-07-10T07:53:45+08:00","dateModified":"2023-07-15T15:28:35+08:00","publisher":{"@type":"Organization","name":"Jian YE","logo":"https:\/\/jianye0428.github.io\/images\/favicon\/jian_icon.png"},"author":{"@type":"Person","name":"Jian YE"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title="yejian's blog"><img loading=lazy src=/images/favicon/jian_icon.png srcset="/images/favicon/jian_icon.png, /images/favicon/jian_icon.png 1.5x, /images/favicon/jian_icon.png 2x" sizes=auto data-title="yejian's blog" data-alt="yejian's blog" class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Jian's Blog</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class="menu-item has-children"><a class=menu-link href=/about/><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden=true></i> 关于</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/projects/ title=项目><i class="fa-solid fa-laptop-code fa-fw fa-sm" aria-hidden=true></i> 我的项目</a></li></ul></li><li class=menu-item><a class=menu-link href=/pilot/><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden=true></i> 导航</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="yejian's blog"><img loading=lazy src=/images/favicon/jian_icon.png srcset="/images/favicon/jian_icon.png, /images/favicon/jian_icon.png 1.5x, /images/favicon/jian_icon.png 2x" sizes=auto data-title=/images/favicon/jian_icon.png data-alt=/images/favicon/jian_icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Jian's Blog</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/about/><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden=true></i> 关于</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/projects/ title=项目><i class="fa-solid fa-laptop-code fa-fw fa-sm" aria-hidden=true></i> 我的项目</a></li></ul></li><li class=menu-item><a class=menu-link href=/pilot/><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden=true></i> 导航</a></li><li class="menu-item text-center"><a class=menu-link href=https://github.com/jianye0428/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw' aria-hidden=true></i></a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class="container container-reverse"><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>深度学习分布式训练框架 horovod[3] -- Horovodrun背后做了什么</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/jianye0428 title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img loading=lazy src="https://gravatar.loli.net/avatar/cf02161235cc969481ed1f4f8e5e0ba6?s=32&amp;d=mp" srcset="https://gravatar.loli.net/avatar/cf02161235cc969481ed1f4f8e5e0ba6?s=32&amp;d=mp, https://gravatar.loli.net/avatar/cf02161235cc969481ed1f4f8e5e0ba6?s=32&amp;d=mp 1.5x, https://gravatar.loli.net/avatar/cf02161235cc969481ed1f4f8e5e0ba6?s=32&amp;d=mp 2x" sizes=auto data-title="Jian YE" data-alt="Jian YE" class=avatar style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>&nbsp;Jian YE</a></span>
<span class=post-category>收录于 <a href=/categories/distributed-computing/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Distributed Computing</a></span></div><div class=post-meta-line><span title="发布于 2023-07-10 07:53:45"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2023-07-10>2023-07-10</time></span>&nbsp;<span title="更新于 2023-07-15 15:28:35"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2023-07-15>2023-07-15</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 10894 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 22 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="深度学习分布式训练框架 horovod[3] -- Horovodrun背后做了什么">
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#0-摘要>0 摘要</a></li><li><a href=#1-背景知识>1 背景知识</a><ul><li><a href=#11-分布式体系>1.1 分布式体系</a></li><li><a href=#12-并行任务通信>1.2 并行任务通信</a></li><li><a href=#13-mpi>1.3 MPI</a></li><li><a href=#14-open-mpi>1.4 Open-MPI</a></li><li><a href=#15-mpi-使用问题>1.5 MPI 使用问题</a></li></ul></li><li><a href=#2-入口点>2 入口点</a><ul><li><a href=#21-如何运行>2.1 如何运行</a></li><li><a href=#22-horovodrun>2.2 horovodrun</a></li><li><a href=#23-run_commandline>2.3 run_commandline</a></li><li><a href=#24-非弹性训练-_run_static>2.4 非弹性训练 _run_static()</a></li></ul></li><li><a href=#3-运行训练-job>3 运行训练 Job</a><ul><li><a href=#31-_launch_job>3.1 _launch_job</a></li><li><a href=#32-run_controller>3.2 run_controller</a></li></ul></li><li><a href=#4-gloo-实现>4 Gloo 实现</a><ul><li><a href=#41-gloo-简介>4.1 Gloo 简介</a></li><li><a href=#42-rendezvous-功能>4.2 Rendezvous 功能</a><ul><li><a href=#421-rendezvous-概念>4.2.1 Rendezvous 概念</a></li><li><a href=#422-rendezvousserver>4.2.2 RendezvousServer</a></li><li><a href=#423-kvstore>4.2.3 KVStore</a></li><li><a href=#424-底层使用>4.2.4 底层使用</a></li></ul></li><li><a href=#43-horovd-的-gloo-入口>4.3 Horovd 的 gloo 入口</a></li><li><a href=#44-构建可执行环境>4.4 构建可执行环境</a><ul><li><a href=#441-_exec_command_fn>4.4.1 _exec_command_fn</a></li><li><a href=#442-get_remote_command>4.4.2 get_remote_command</a></li></ul></li><li><a href=#45-使用-gloo-执行命令>4.5 使用 gloo 执行命令</a><ul><li><ul><li><a href=#4512-分配方案>4.5.1.2 分配方案</a></li></ul></li><li><a href=#452-得到运行命令>4.5.2 得到运行命令</a></li><li><a href=#453-得到slot运行命令>4.5.3 得到slot运行命令</a></li><li><a href=#454-多线程调用命令>4.5.4 多线程调用命令</a></li></ul></li><li><a href=#46-c举例>4.6 C++举例</a></li></ul></li><li><a href=#5-mpi-实现>5 Mpi 实现</a><ul><li><a href=#51-openmpi-库>5.1 openmpi 库</a></li><li><a href=#52-mpi_run-函数>5.2 mpi_run 函数</a></li><li><a href=#53-mpirun命令>5.3 mpirun命令</a></li></ul></li><li><a href=#6-总结>6 总结</a><ul><li><a href=#61-gloo>6.1 gloo</a></li><li><a href=#62-mpi>6.2 mpi</a></li></ul></li></ul></nav></div></div><div class=content id=content data-end-flag=（完）><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fa-solid fa-exclamation-triangle fa-fw" aria-hidden=true></i>警告<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>本文最后更新于 2023-07-15，文中内容可能已过时。</div></div></div><p>references:
[1]. <a href=https://www.cnblogs.com/rossiXYZ/p/14881812.html target=_blank rel="external nofollow noopener noreferrer">https://www.cnblogs.com/rossiXYZ/p/14881812.html<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></p><h2 id=0-摘要>0 摘要</h2><p>Horovod 是Uber于2017年发布的一个易于使用的高性能的分布式训练框架，在业界得到了广泛应用。</p><p>本系列将通过源码分析来带领大家了解 Horovod。本文是系列第三篇，从 python 开始进入 Horovod 世界，看看 Horovodrun 做了什么。</p><p>前两篇链接如下：</p><p><a href=https://www.cnblogs.com/rossiXYZ/p/14856464.html target=_blank rel="external nofollow noopener noreferrer">深度学习分布式训练框架 Horovod (1) &mdash; 基础知识<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></p><p><a href=https://www.cnblogs.com/rossiXYZ/p/14856543.html target=_blank rel="external nofollow noopener noreferrer">深度学习分布式训练框架 horovod (2) &mdash; 从使用者角度切入<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></p><h2 id=1-背景知识>1 背景知识</h2><p>首先介绍一些相关背景知识。</p><h3 id=11-分布式体系>1.1 分布式体系</h3><p>在设计并行计算机时，<u>最直接的方式就是<mark>多个计算单元共享一个内存</mark></u>。共享内存的编程在数据交换和访问上有较大的优势，程序编写起来更加简单。<font color=red>但在扩展性上有较大的瓶颈</font>。</p><p>另一种方式为<font color=red><strong>分布式内存</strong></font>。即<u>每个计算单元有单独的内存，计算单元之间的数据访问通过互联网络去传输</u>。这一架构在可移植性和扩展上会强很多，但<u>消息的传递</u>会成为程序设计中的难点。</p><p>将这两点结合，即是<u><font color=red><strong>分布式共享内存并行计算机的架构</strong></font></u>，也是当今最常用的体系结构。</p><h3 id=12-并行任务通信>1.2 并行任务通信</h3><p>并行任务通信一般分为<font color=red><strong>P2P</strong>(Point-to-point communication)</font>和 <font color=red><strong>Collective communication</strong></font>。</p><ul><li>P2P通信这种模式只有一个sender和一个receiver，即点到点通信.</li><li>Collective communication含多个sender多个receive</li></ul><p>Collective communication包含一些常见的原语</p><ul><li>broadcast</li><li>reduce，allreduce</li><li>scatter，scatter reduce</li><li>gather，allgather</li><li>ring-base collectives</li><li>ring-allreduce</li></ul><p>传统Collective communication假设通信节点组成的topology是一颗fat tree，这样通信效率最高。但实际的通信topology可能比较复杂，并不是一个fat tree。因此一般用<mark><strong>ring-based Collective communication</strong></mark>。</p><h3 id=13-mpi>1.3 MPI</h3><p><mark>MPI(Message Passing Interface)</mark> 是一种可以支持点对点和广播的通信协议，具体实现的库有很多，使用比较流行的包括 Open Mpi， Intel MPI 等等。</p><p>MPI 是一种<u>消息传递编程模型</u>。消息传递指用户必须通过显式地发送和接收消息来实现处理器间的数据交换。在这种并行编程中，<font color=red>每个控制流均有自己独立的地址空间，不同的控制流之间不能直接访问彼此的地址空间，必须通过显式的消息传递来实现</font>。这种编程方式是<mark>大规模并行处理机(MPP)</mark>和<mark>机群(Cluster)</mark>采用的主要编程方式。由于消息传递程序设计要求用户很好地分解问题，组织不同控制流间的数据交换，并行计算粒度大，特别适合于大规模可扩展并行算法。</p><p>MPI 是<mark>基于进程的并行环境。进程拥有独立的虚拟地址空间和处理器调度，并且执行相互独立</mark>。MPI 设计为支持通过网络连接的机群系统，且通过消息传递来实现通信，消息传递是 MPI 的最基本特色。</p><h3 id=14-open-mpi>1.4 Open-MPI</h3><p>OpenMPI 是一种高性能消息传递库，最初是作为融合的技术和资源从其他几个项目（FT-MPI， LA-MPI， LAM/MPI， 以及 PACX-MPI），它是 MPI-2 标准的一个开源实现，由一些科研机构和企业一起开发和维护。因此，OpenMPI 能够从高性能社区中获得专业技术、工业技术和资源支持，来创建最好的 MPI 库。OpenMPI 提供给系统和软件供应商、程序开发者和研究人员很多便利。易于使用，并运行本身在各种各样的操作系统，网络互连，以及一批/调度系统。</p><h3 id=15-mpi-使用问题>1.5 MPI 使用问题</h3><p>因为MPI是<u>分布式内存编程</u>，在后面的开发中涉及节点间信息的传递。往往数据和程序是在多个节点上，所以需要保证执行命令时各节点之间信息的交换。</p><p>具体使用之中，就有两个问题:</p><ul><li>这个多台机器Open-MPI是如何发现并建立连接的呢？</li><li>多机多卡在训练过程中，传输环如何建立，这个也是决定了训练效率，那么Open-MPI如何去做呢？</li></ul><p>关于第一个问题：</p><p>设置<font color=red>SSH免密登录</font>可以免去操作中密码的输入。各节点生成私钥和公钥后需要认证，此时可以保证本机免密登录。将各个子节点的公钥文件发送给主节点，然后分别加入到主节点的认证文件中，此时可以保证主节点对各个子节点的免密登录。最后将认证文件传回到每个子节点，从而保证各个子节点对其他节点之间的免密登录。</p><p>在 Open-MPI 启动的时候，可以指定<code>--hostfile</code>或者<code>--host</code>去指定要运行任务的 IP 或 Hostname，这样 Open-MPI 就会试图通过 ssh 免秘钥的方式试图去链接对方机器，并执行一系列命令，主要是为了<strong>同步环境变量、当前路径以及下发启动命令</strong>。</p><p>当然用户也可以通过其他方式给远程机器下发命令，这个可以通过环境变量<code>OMPI_MCA_plm_rsh_agent</code>指定。</p><p>关于第二个问题：</p><p>当所有的机器建立好连接，准备开始计算，为了能够最高效的去通信，Open-MPI中集成了组件——<a href=https://github.com/open-mpi/hwloc target=_blank rel="external nofollow noopener noreferrer">hwloc<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>。该组件主要是<font color=red><strong>为了单机硬件资源拓扑构建，进而构建最短路径通信</strong></font>。</p><h2 id=2-入口点>2 入口点</h2><p>很多机器学习框架都会采用如下套路：shell脚本（可选），python端 和 C++端。</p><ul><li>Shell脚本是启动运行的入口，负责解析参数，确认并且调用训练程序；</li><li>Python是用户的接口，引入了C++库，封装了API，负责运行时和底层C++交互；</li><li>C++实现底层训练逻辑；</li></ul><p>以我们先看看 hordovodrun 脚本。</p><h3 id=21-如何运行>2.1 如何运行</h3><p>官方给出的 Hovorod 运行范例之一如下：</p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>horovodrun</span> <span class=o>-</span><span class=n>np</span> <span class=mi>2</span> <span class=o>-</span><span class=n>H</span> <span class=n>localhost</span><span class=p>:</span><span class=mi>4</span> <span class=o>--</span><span class=n>gloo</span> <span class=n>python</span> <span class=o>/</span><span class=n>horovod</span><span class=o>/</span><span class=n>examples</span><span class=o>/</span><span class=n>tensorflow2</span><span class=o>/</span><span class=n>tensorflow2_mnist</span><span class=o>.</span><span class=n>py</span></span></span></code></pre></td></tr></table></div></div><p>这里 -np 指的是<strong>进程的数量</strong>，localhost:4<strong>表示localhost节点上4个GPU</strong>。</p><p>注意，如果虚拟机只有一个核。想要强行地达到并行的效果，可以使用 -np参数，它会自动帮你把一个核心切成多份处理器，每一个分布式处理就是一个slot。</p><p>因此，我们可以从 horovodrun 这个命令入手看看。</p><h3 id=22-horovodrun>2.2 horovodrun</h3><p>入口文件可以从 setup.py 看到，其就被映射成 horovod.runner.launch:run_commandline。</p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>entry_points</span><span class=o>={</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;console_scripts&#39;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;horovodrun = horovod.runner.launch:run_commandline&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div><p>所以我们看看 run_commandline</p><h3 id=23-run_commandline>2.3 run_commandline</h3><p>该命令位于：horovod-master/horovod/runner/launch.py，我们摘录重要部分。</p><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_commandline</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>_run</span><span class=p>(</span><span class=n>args</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>于是进入到 _run 函数。可以看到，Horovod 会依据是否是弹性训练来选择不同的路径。我们在此系列中，会首先分析 非弹性训练 _run_static。</p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>_run</span><span class=p>(</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># if hosts are not specified, either parse from hostfile, or default as</span>
</span></span><span class=line><span class=cl>    <span class=c1># localhost</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>args</span><span class=o>.</span><span class=n>hosts</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>args</span><span class=o>.</span><span class=n>host_discovery_script</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>hostfile</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>args</span><span class=o>.</span><span class=n>hosts</span> <span class=o>=</span> <span class=n>hosts</span><span class=o>.</span><span class=n>parse_host_files</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>hostfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Set hosts to localhost if not specified</span>
</span></span><span class=line><span class=cl>            <span class=n>args</span><span class=o>.</span><span class=n>hosts</span> <span class=o>=</span> <span class=s1>&#39;localhost:</span><span class=si>{np}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>np</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>np</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Convert nics into set</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span><span class=o>.</span><span class=n>nics</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>nics</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>))</span> <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>nics</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>_is_elastic</span><span class=p>(</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>_run_elastic</span><span class=p>(</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>_run_static</span><span class=p>(</span><span class=n>args</span><span class=p>)</span> <span class=c1># 我们先看这里</span></span></span></code></pre></td></tr></table></div></div><h3 id=24-非弹性训练-_run_static>2.4 非弹性训练 _run_static()</h3><p>在 _run_static 之中做了如下操作：</p><ul><li>首先解析各种参数，得到 settings；</li><li>会调用 <code>driver_service.get_common_interfaces</code> 获取网卡以及其他host的信息，依据这些信息会进行slot分配，这部分很复杂，具体我们会有专文讲解（下一篇）。</li><li>这里有一个问题：为什么要得到 host, slot, rank 之间的关系信息？由于工程上的考虑，底层 C++ 世界中对于 rank 的角色做了区分：<code>rank 0</code> 是 master，<code>rank n</code> 是 worker，所以这些信息需要决定并且传递给 C++世界；</li><li>会根据是否在参数中传递运行函数来决定采取何种路径，一般默认没有运行参数，所以会执行_launch_job 来启动训练 job；</li></ul><p>具体代码如下：</p><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>_run_static</span><span class=p>(</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>settings</span> <span class=o>=</span> <span class=n>hvd_settings</span><span class=o>.</span><span class=n>Settings</span><span class=p>(</span><span class=n>verbose</span><span class=o>=</span><span class=mi>2</span> <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>verbose</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>ssh_port</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>ssh_port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>ssh_identity_file</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>ssh_identity_file</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>extra_mpi_args</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>mpi_args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>tcp_flag</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>tcp_flag</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>binding_args</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>binding_args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>key</span><span class=o>=</span><span class=n>secret</span><span class=o>.</span><span class=n>make_secret_key</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                                     <span class=n>start_timeout</span><span class=o>=</span><span class=n>tmout</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>num_proc</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>np</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>hosts</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>hosts</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>output_filename</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>output_filename</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>run_func_mode</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>run_func</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>nics</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>nics</span><span class=p>,</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	  <span class=c1># 首先解析各种参数，得到 settings</span>
</span></span><span class=line><span class=cl>    <span class=n>fn_cache</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>args</span><span class=o>.</span><span class=n>disable_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>np</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span> <span class=o>+=</span> <span class=nb>str</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>np</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39; &#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>hosts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span> <span class=o>+=</span> <span class=nb>str</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>hosts</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39; &#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>ssh_port</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span> <span class=o>+=</span> <span class=nb>str</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>ssh_port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>ssh_identity_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span> <span class=o>+=</span> <span class=n>args</span><span class=o>.</span><span class=n>ssh_identity_file</span>
</span></span><span class=line><span class=cl>        <span class=n>parameters_hash</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>params</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>fn_cache</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=n>Cache</span><span class=p>(</span><span class=n>CACHE_FOLDER</span><span class=p>,</span> <span class=n>CACHE_STALENESS_THRESHOLD_MINUTES</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                               <span class=n>parameters_hash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 获取网卡以及其他host的信息，依据这些信息会进行slot分配</span>
</span></span><span class=line><span class=cl>    <span class=n>all_host_names</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>hosts</span><span class=o>.</span><span class=n>parse_hosts_and_slots</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>hosts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>remote_host_names</span> <span class=o>=</span> <span class=n>network</span><span class=o>.</span><span class=n>filter_local_addresses</span><span class=p>(</span><span class=n>all_host_names</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>nics</span> <span class=o>=</span> <span class=n>driver_service</span><span class=o>.</span><span class=n>get_common_interfaces</span><span class=p>(</span><span class=n>settings</span><span class=p>,</span> <span class=n>all_host_names</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>remote_host_names</span><span class=p>,</span> <span class=n>fn_cache</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>run_func</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># get the driver IPv4 address</span>
</span></span><span class=line><span class=cl>        <span class=n>driver_ip</span> <span class=o>=</span> <span class=n>network</span><span class=o>.</span><span class=n>get_driver_ip</span><span class=p>(</span><span class=n>nics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>run_func_server</span> <span class=o>=</span> <span class=n>KVStoreServer</span><span class=p>(</span><span class=n>verbose</span><span class=o>=</span><span class=n>settings</span><span class=o>.</span><span class=n>verbose</span><span class=p>)</span> <span class=c1># 启动内部KV服务器</span>
</span></span><span class=line><span class=cl>        <span class=n>run_func_server_port</span> <span class=o>=</span> <span class=n>run_func_server</span><span class=o>.</span><span class=n>start_server</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>put_data_into_kvstore</span><span class=p>(</span><span class=n>driver_ip</span><span class=p>,</span> <span class=n>run_func_server_port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                              <span class=s1>&#39;runfunc&#39;</span><span class=p>,</span> <span class=s1>&#39;func&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>.</span><span class=n>run_func</span><span class=p>)</span> <span class=c1># 把&#39;func&#39;, args.run_func存储成KV</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>command</span> <span class=o>=</span> <span class=p>[</span><span class=n>sys</span><span class=o>.</span><span class=n>executable</span><span class=p>,</span> <span class=s1>&#39;-m&#39;</span><span class=p>,</span> <span class=s1>&#39;horovod.runner.run_task&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>driver_ip</span><span class=p>),</span> <span class=nb>str</span><span class=p>(</span><span class=n>run_func_server_port</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>_launch_job</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=n>settings</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span> <span class=o>=</span> <span class=p>[</span><span class=kc>None</span><span class=p>]</span> <span class=o>*</span> <span class=n>args</span><span class=o>.</span><span class=n>np</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>np</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>results</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>read_data_from_kvstore</span><span class=p>(</span><span class=n>driver_ip</span><span class=p>,</span> <span class=n>run_func_server_port</span><span class=p>,</span><span class=s1>&#39;runfunc_result&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>run_func_server</span><span class=o>.</span><span class=n>shutdown_server</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>command</span> <span class=o>=</span> <span class=n>args</span><span class=o>.</span><span class=n>command</span>
</span></span><span class=line><span class=cl>        <span class=n>_launch_job</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=n>settings</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>command</span><span class=p>)</span> <span class=c1># 我们重点讲解这里</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span></span></span></code></pre></td></tr></table></div></div><p>目前逻辑如下：</p><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>              </span><span class=o>+-----------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=o>|</span><span class=n>horovodrun</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=o>+-----+-----+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=o>+--------+--------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=o>|</span><span class=w> </span><span class=n>run_commandline</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=o>+----+------+-----+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>+---------+</span><span class=w>      </span><span class=o>+--------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>|</span><span class=w>                         </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>|</span><span class=w>                         </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>v</span><span class=w>                         </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+-----+--------+</span><span class=w>           </span><span class=o>+----+--------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>_run_elastic</span><span class=w> </span><span class=o>|</span><span class=w>           </span><span class=o>|</span><span class=w> </span><span class=n>_run_static</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>              </span><span class=o>|</span><span class=w>           </span><span class=o>|</span><span class=w>             </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+--------------+</span><span class=w>           </span><span class=o>+-------------+</span></span></span></code></pre></td></tr></table></div></div><p>至此，我们已经分析完成 horovod 的入口，下面会分析具体如何启动 Job。</p><h2 id=3-运行训练-job>3 运行训练 Job</h2><h3 id=31-_launch_job>3.1 _launch_job</h3><p>_launch_job 会根据配置或者安装情况来进行具体调用。我们看到有三种可能：gloo, mpi, js。</p><p>jsrun的资料很难找，所以我们重点看看 gloo, mpi 这两种。</p><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>_launch_job</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=n>settings</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>env</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>config_parser</span><span class=o>.</span><span class=n>set_env_from_args</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>gloo_run_fn</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>driver_ip</span> <span class=o>=</span> <span class=n>network</span><span class=o>.</span><span class=n>get_driver_ip</span><span class=p>(</span><span class=n>nics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>gloo_run</span><span class=p>(</span><span class=n>settings</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>env</span><span class=p>,</span> <span class=n>driver_ip</span><span class=p>,</span> <span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mpi_run_fn</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>mpi_run</span><span class=p>(</span><span class=n>settings</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>env</span><span class=p>,</span> <span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>js_run_fn</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>js_run</span><span class=p>(</span><span class=n>settings</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>env</span><span class=p>,</span> <span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>run_controller</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>use_gloo</span><span class=p>,</span> <span class=n>gloo_run_fn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>args</span><span class=o>.</span><span class=n>use_mpi</span><span class=p>,</span> <span class=n>mpi_run_fn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>args</span><span class=o>.</span><span class=n>use_jsrun</span><span class=p>,</span> <span class=n>js_run_fn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>args</span><span class=o>.</span><span class=n>verbose</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><h3 id=32-run_controller>3.2 run_controller</h3><p>run_controller 依然是一个中介函数，具体导入 gloo 或者 mpi。</p><div class=highlight id=id-8><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_controller</span><span class=p>(</span><span class=n>use_gloo</span><span class=p>,</span> <span class=n>gloo_run</span><span class=p>,</span> <span class=n>use_mpi</span><span class=p>,</span> <span class=n>mpi_run</span><span class=p>,</span> <span class=n>use_jsrun</span><span class=p>,</span> <span class=n>js_run</span><span class=p>,</span> <span class=n>verbosity</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>use_gloo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>gloo_run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>use_mpi</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>mpi_run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>use_jsrun</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>js_run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>mpi_built</span><span class=p>(</span><span class=n>verbose</span><span class=o>=</span><span class=n>verbose</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>lsf</span><span class=o>.</span><span class=n>LSFUtils</span><span class=o>.</span><span class=n>using_lsf</span><span class=p>()</span> <span class=ow>and</span> <span class=n>is_jsrun_installed</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>js_run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>mpi_run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>gloo_built</span><span class=p>(</span><span class=n>verbose</span><span class=o>=</span><span class=n>verbose</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>gloo_run</span><span class=p>()</span></span></span></code></pre></td></tr></table></div></div><p>目前逻辑如下：</p><div class=highlight id=id-9><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>              </span><span class=o>+-----------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=o>|</span><span class=n>horovodrun</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=o>+-----+-----+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=o>+--------+--------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=o>|</span><span class=w> </span><span class=n>run_commandline</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=o>+----+------+-----+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>+---------+</span><span class=w>      </span><span class=o>+--------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>|</span><span class=w>                         </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>|</span><span class=w>                         </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>v</span><span class=w>                         </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+-----+--------+</span><span class=w>           </span><span class=o>+----+--------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>_run_elastic</span><span class=w> </span><span class=o>|</span><span class=w>           </span><span class=o>|</span><span class=w> </span><span class=n>_run_static</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>              </span><span class=o>|</span><span class=w>           </span><span class=o>|</span><span class=w>             </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+--------------+</span><span class=w>           </span><span class=o>+------+------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=o>+------+------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=o>|</span><span class=w> </span><span class=n>_launch_job</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=o>|</span><span class=w>             </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=o>+------+------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+---------+--------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>|</span><span class=w>  </span><span class=n>run_controller</span><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>|</span><span class=w>                  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+----+----+-----+--+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                             </span><span class=o>|</span><span class=w>    </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=o>+-------------+</span><span class=w>    </span><span class=o>|</span><span class=w>     </span><span class=o>+--------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=o>|</span><span class=w>                  </span><span class=o>|</span><span class=w>              </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=o>|</span><span class=w>                  </span><span class=o>|</span><span class=w>              </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>v</span><span class=w>                  </span><span class=n>v</span><span class=w>              </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>+------+---+</span><span class=w>       </span><span class=o>+------+----+</span><span class=w>     </span><span class=o>+---+-----+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=n>gloo_run</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>   </span><span class=n>mpi_run</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>js_run</span><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>          </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>           </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>         </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>+----------+</span><span class=w>       </span><span class=o>+-----------+</span><span class=w>     </span><span class=o>+---------+</span></span></span></code></pre></td></tr></table></div></div><p>于是我们下面就分为两个分支介绍：gloo & mpi。</p><h2 id=4-gloo-实现>4 Gloo 实现</h2><h3 id=41-gloo-简介>4.1 Gloo 简介</h3><p>Gloo 是 facebook出品的一个类似MPI的集合通信库（https://github.com/facebookincubator/gloo）。</p><p>集合通信库的主要特征是：大体上会遵照 MPI 提供的接口规定，实现了包括<strong>点对点通信</strong>（SEND,RECV等），<strong>集合通信</strong>（ REDUCE，BROADCAST，ALLREDUCE等）等相关接口，然后根据自己硬件或者是系统的需要，在底层实现上进行相应改动，保证接口的稳定和性能。</p><p>Gloo 为CPU和GPU提供了集合通信程序的优化实现。 它特别适用于GPU，因为它可以执行通信而无需使用GPUDirect 将数据传输到CPU的内存。 它还能够使用 NCCL 执行快速的节点内通信，并实现其自己的节点间例程计算。你不需要考虑内存数据的拷贝，只需要实现逻辑就可以。</p><p>Gloo 支持集合通信（collective Communication），并对其进行了优化。由于 GPU 之间可以直接进行数据交换，而无需经过 CPU 和内存，因此，在 GPU 上使用 <strong>gloo后端</strong>速度更快。</p><p>Horovod 为什么会选择 Gloo？个人认为除了其功能的全面性和性能之外，基于它可以二次开发是一个亮点，比如下面我们所说的 Rendezvous 功能就被 Horovod 用来实现弹性训练（我们后文有专门讲解）。</p><p>Gloo 和 MPI 都起到了同样类似作用：</p><ul><li>一方面Horovod内集成了基于 Gloo 的AllReduce，类似于NCCL，都是用作梯度规约；</li><li>另一方面，Gloo 可以用来启动多个进程（Hovorod里用Rank表示），实现并行计算；</li></ul><p>具体如下：</p><div class=highlight id=id-10><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>   </span><span class=o>+-----------------------+</span><span class=w>   </span><span class=o>+-----------------------+</span><span class=w>  </span><span class=o>+------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>  </span><span class=n>gloo_run</span><span class=w>      </span><span class=n>slot</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=n>gloo_run</span><span class=w>     </span><span class=n>slot</span><span class=w> </span><span class=n>2</span><span class=w>   </span><span class=o>|</span><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=n>gloo_run</span><span class=w>  </span><span class=n>slot</span><span class=w> </span><span class=n>3</span><span class=w>      </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>                       </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>                       </span><span class=o>|</span><span class=w>  </span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>+-------------------+</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>+------------------+</span><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=o>+------------------+</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>python</span><span class=w> </span><span class=n>train</span><span class=p>.</span><span class=na>py</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>  </span><span class=n>python</span><span class=w> </span><span class=n>train</span><span class=p>.</span><span class=na>py</span><span class=w> </span><span class=o>|</span><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>python</span><span class=w> </span><span class=n>train</span><span class=p>.</span><span class=na>py</span><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+----+</span><span class=w>                   </span><span class=o>+&lt;------+</span><span class=w>                  </span><span class=o>+&lt;------+</span><span class=w>                  </span><span class=o>+&lt;------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>                   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>                  </span><span class=o>|</span><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>                  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=o>+-------------------+</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>+------------------+</span><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=o>+------------------+</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>  </span><span class=o>|</span><span class=w>                       </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>                       </span><span class=o>|</span><span class=w>  </span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>  </span><span class=o>+-----------------------+</span><span class=w>   </span><span class=o>+-----------------------+</span><span class=w>  </span><span class=o>+------------------------+</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                                                                                      </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                                                                                      </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                                                                                      </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>v</span><span class=o>--------------------------------------------------------------------------------------&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                     </span><span class=n>Ring</span><span class=w> </span><span class=n>Allreduce</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=n>Gloo</span></span></span></code></pre></td></tr></table></div></div><h3 id=42-rendezvous-功能>4.2 Rendezvous 功能</h3><h4 id=421-rendezvous-概念>4.2.1 Rendezvous 概念</h4><p>在 Gloo 的文档中，如此说:</p><div class=highlight id=id-11><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The rendezvous process needs to happen exactly once per Gloo context.
</span></span><span class=line><span class=cl>It makes participating Gloo processes exchange details for setting up their communication channels. For example, when the TCP transport is used, processes exchange IP address and port number details of listening sockets.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Rendezvous can be executed by accessing a key/value store that is accessible by all participating processes. Every process is responsible for setting a number of keys and will wait until their peers have set their keys. The values stored against these keys hold
</span></span><span class=line><span class=cl>the information that is passed to the transport layer.</span></span></code></pre></td></tr></table></div></div><p>大致意思是：</p><p>Gloo 在每一个 Gloo context 之中有一个 rendezvous process，Gloo 利用它来<strong>交换通讯需要的细节</strong>。</p><p>Rendezvous 具体实现是可以依靠访问一个 KVstore 来完成。具体细节就是通过 KVstore 来进行交互。</p><p>以 Horovod 为例：</p><ul><li>Horovod 在进行容错 AllReduce 训练时，除了启动 <strong>worker 进程</strong>外，还会启动一个<strong>driver 进程</strong>。这个 driver 进程用于帮助 worker 调用 gloo 构造 AllReduce 通信环。</li><li>driver 进程中会创建一个带有 KVStore 的 RendezvousServer，driver 会将参与通信的 worker 的 ip 等信息存入 KVstore 中。</li><li>然后 worker 就可以调用 gloo 来访问 RendezvousServer 构造通信环了。</li></ul><h4 id=422-rendezvousserver>4.2.2 RendezvousServer</h4><p>具体代码如下，可以看到是启动了RendezvousHTTPServer(就是继承拓展了 HTTPServer):</p><div class=highlight id=id-12><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>RendezvousServer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_httpd</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_listen_thread</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_verbose</span> <span class=o>=</span> <span class=n>verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Rendezvous function finds a available port, create http socket,</span>
</span></span><span class=line><span class=cl>    <span class=c1># and start listening loop to handle request</span>
</span></span><span class=line><span class=cl>    <span class=c1># self.httpd.init needs to be called after server start</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>start</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>handler_cls</span><span class=o>=</span><span class=n>RendezvousHandler</span><span class=p>):</span> <span class=c1># 下面马上介绍</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_httpd</span><span class=p>,</span> <span class=n>port</span> <span class=o>=</span> <span class=n>find_port</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>lambda</span> <span class=n>addr</span><span class=p>:</span> <span class=n>RendezvousHTTPServer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>addr</span><span class=p>,</span> <span class=n>handler_cls</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_verbose</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># start the listening loop</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_listen_thread</span> <span class=o>=</span> <span class=n>in_thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_httpd</span><span class=o>.</span><span class=n>serve_forever</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>port</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>init</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>host_alloc_plan</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_httpd</span><span class=o>.</span><span class=n>init</span><span class=p>(</span><span class=n>host_alloc_plan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>stop</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_httpd</span><span class=o>.</span><span class=n>shutdown</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_listen_thread</span><span class=o>.</span><span class=n>join</span><span class=p>()</span></span></span></code></pre></td></tr></table></div></div><h4 id=423-kvstore>4.2.3 KVStore</h4><p>KVStore 是由 KVStoreHandler 来体现，RendezvousHandler 继承了 KVStoreHandler，进而被 RendezvousServer 作为 handler 使用。</p><p>KVStoreHandler 精简版代码如下：</p><div class=highlight id=id-13><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>KVStoreHandler</span><span class=p>(</span><span class=n>SimpleHTTPRequestHandler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Override PUT handler</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>do_PUT</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>paths</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>_</span><span class=p>,</span> <span class=n>scope</span><span class=p>,</span> <span class=n>key</span> <span class=o>=</span> <span class=n>paths</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Get body length</span>
</span></span><span class=line><span class=cl>        <span class=n>content_length</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s1>&#39;Content-Length&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rfile</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>content_length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_put_value</span><span class=p>(</span><span class=n>scope</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>send_status_code</span><span class=p>(</span><span class=n>OK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_put_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>scope</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>server</span><span class=o>.</span><span class=n>cache_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>scope_dict</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>server</span><span class=o>.</span><span class=n>cache</span><span class=o>.</span><span class=n>setdefault</span><span class=p>(</span><span class=n>scope</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>            <span class=n>scope_dict</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span></span></span></code></pre></td></tr></table></div></div><h4 id=424-底层使用>4.2.4 底层使用</h4><p>Rendezvous 具体如何使用？简要的说：</p><ul><li>Python世界构建了一个 RendezvousServer，其地址配置在环境变量（或者其他方式）中。</li><li>在 C++ 世界中，比如 horovod/common/gloo/gloo_context.h，horovod/common/gloo/gloo_context.cc 之中有使用。即得到 Python 配置的 RendezvousServer 的地址端口等，然后构建 gloo 所需的 context。</li></ul><div class=highlight id=id-14><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=cp>#define HOROVOD_HOSTNAME &#34;HOROVOD_HOSTNAME&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#define HOROVOD_RANK &#34;HOROVOD_RANK&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#define HOROVOD_SIZE &#34;HOROVOD_SIZE&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#define HOROVOD_LOCAL_RANK &#34;HOROVOD_LOCAL_RANK&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#define HOROVOD_LOCAL_SIZE &#34;HOROVOD_LOCAL_SIZE&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#define HOROVOD_CROSS_RANK &#34;HOROVOD_CROSS_RANK&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#define HOROVOD_CROSS_SIZE &#34;HOROVOD_CROSS_SIZE&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#define HOROVOD_ELASTIC &#34;HOROVOD_ELASTIC&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>  <span class=n>ctx</span> <span class=o>=</span> <span class=n>Rendezvous</span><span class=p>(</span><span class=n>HOROVOD_GLOO_GLOBAL_PREFIX</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>rendezvous_addr_env</span><span class=p>,</span> <span class=n>rendezvous_port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>rank</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>dev</span><span class=p>,</span> <span class=n>timeout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>local_ctx</span> <span class=o>=</span> <span class=n>Rendezvous</span><span class=p>(</span><span class=n>HOROVOD_GLOO_LOCAL_PREFIX</span> <span class=o>+</span> <span class=n>hostname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>rendezvous_addr_env</span><span class=p>,</span> <span class=n>rendezvous_port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>local_rank</span><span class=p>,</span> <span class=n>local_size</span><span class=p>,</span> <span class=n>dev</span><span class=p>,</span> <span class=n>timeout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>cross_ctx</span> <span class=o>=</span> <span class=n>Rendezvous</span><span class=p>(</span><span class=n>HOROVOD_GLOO_CROSS_PREFIX</span> <span class=o>+</span> <span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>local_rank</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                         <span class=n>rendezvous_addr_env</span><span class=p>,</span> <span class=n>rendezvous_port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>cross_rank</span><span class=p>,</span> <span class=n>cross_size</span><span class=p>,</span> <span class=n>dev</span><span class=p>,</span> <span class=n>timeout</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><p>逻辑如下，C++世界会从python世界的获取到RendezvousServer的 IP，port：</p><div class=highlight id=id-15><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>          </span><span class=o>+---------------------&gt;</span><span class=w>  </span><span class=n>System</span><span class=w> </span><span class=n>Env</span><span class=w>  </span><span class=o>+------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>|</span><span class=w>  </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=p>...</span><span class=w>                     </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=p>...</span><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>|</span><span class=w>                            </span><span class=o>+</span><span class=w>                          </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>|</span><span class=w>                            </span><span class=o>|</span><span class=w>                          </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>|</span><span class=w>                            </span><span class=o>|</span><span class=w>                          </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>|</span><span class=w>                            </span><span class=o>|</span><span class=w>                          </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>|</span><span class=w>                            </span><span class=o>|</span><span class=w>                          </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>|</span><span class=w>                            </span><span class=o>|</span><span class=w>                          </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>|</span><span class=w>    </span><span class=n>Python</span><span class=w>                  </span><span class=o>|</span><span class=w>              </span><span class=n>C</span><span class=o>++</span><span class=w>         </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>|</span><span class=w>                            </span><span class=o>|</span><span class=w>                          </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>|</span><span class=w>                            </span><span class=o>|</span><span class=w>                          </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>|</span><span class=w>                            </span><span class=o>|</span><span class=w>                          </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>|</span><span class=w>                            </span><span class=o>|</span><span class=w>                          </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+---------+---------------+</span><span class=w>            </span><span class=o>|</span><span class=w>             </span><span class=o>+------------+--------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>RendezvousServer</span><span class=w>        </span><span class=o>|</span><span class=w>            </span><span class=o>|</span><span class=w>             </span><span class=o>|</span><span class=n>GlooContext</span><span class=w>          </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                         </span><span class=o>|</span><span class=w>            </span><span class=o>|</span><span class=w>             </span><span class=o>|</span><span class=w>                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                         </span><span class=o>|</span><span class=w>            </span><span class=o>|</span><span class=w>             </span><span class=o>|</span><span class=w>                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                         </span><span class=o>|</span><span class=w>            </span><span class=o>|</span><span class=w>             </span><span class=o>|</span><span class=w>                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>    </span><span class=n>RendezvousHandler</span><span class=w>    </span><span class=o>|</span><span class=w>            </span><span class=o>|</span><span class=w>             </span><span class=o>|</span><span class=w>      </span><span class=n>Rendezvous</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                         </span><span class=o>|</span><span class=w>            </span><span class=o>|</span><span class=w>             </span><span class=o>|</span><span class=w>                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+-------------------------+</span><span class=w>            </span><span class=o>|</span><span class=w>             </span><span class=o>+---------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                       </span><span class=o>+</span></span></span></code></pre></td></tr></table></div></div><h3 id=43-horovd-的-gloo-入口>4.3 Horovd 的 gloo 入口</h3><p>gloo_run 是 horovod 之中，gloo 模块的 相关入口。</p><p>注释说的很清楚：每一个 thread 将使用 ssh 命令在远程host之上启动训练job。</p><div class=highlight id=id-16><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>gloo_run</span><span class=p>(</span><span class=n>settings</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>env</span><span class=p>,</span> <span class=n>server_ip</span><span class=p>,</span> <span class=n>command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Each thread will use ssh command to launch the job on each remote host. If an</span>
</span></span><span class=line><span class=cl>    <span class=c1># error occurs in one thread, entire process will be terminated. Otherwise,</span>
</span></span><span class=line><span class=cl>    <span class=c1># threads will keep running and ssh session.</span>
</span></span><span class=line><span class=cl>    <span class=n>exec_command</span> <span class=o>=</span> <span class=n>_exec_command_fn</span><span class=p>(</span><span class=n>settings</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>launch_gloo</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>exec_command</span><span class=p>,</span> <span class=n>settings</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>env</span><span class=p>,</span> <span class=n>server_ip</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>就是用 launch_gloo 来运行 exec_command。</p><p>此时 command 参数类似 <code>"['python', 'train.py']"</code>。</p><h3 id=44-构建可执行环境>4.4 构建可执行环境</h3><p>gloo_run 的第一部分是 <code>exec_command = _exec_command_fn(settings)</code>，就是基于各种配置来生成可以执行命令环境。如果是远程，就得生成相关远程可运行命令环境（包括切换目录，远程执行等等）。</p><h4 id=441-_exec_command_fn>4.4.1 _exec_command_fn</h4><p>具体又可以分为两部分：</p><ul><li>利用 get_remote_command 来生成相关远程可运行环境，比如在训练脚本前面加上 <code>'ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no'</code>；</li><li>调整输入输出，利用 safe_shell_exec.execute 来实现安全执行能力；</li></ul><p>具体如下：</p><div class=highlight id=id-17><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>_exec_command_fn</span><span class=p>(</span><span class=n>settings</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    executes the jobs defined by run command on hosts.
</span></span></span><span class=line><span class=cl><span class=s2>    :param hosts_alloc: list of dict indicating the allocating info.
</span></span></span><span class=line><span class=cl><span class=s2>    For example,
</span></span></span><span class=line><span class=cl><span class=s2>        [{&#39;Hostname&#39;:&#39;worker-0&#39;, &#39;Rank&#39;: 0, &#39;Local_rank&#39;: 0, &#39;Cross_rank&#39;:0,
</span></span></span><span class=line><span class=cl><span class=s2>            &#39;Size&#39;:2, &#39;Local_size&#39;:1, &#39;Cross_size&#39;:2},
</span></span></span><span class=line><span class=cl><span class=s2>        {&#39;Hostname&#39;:&#39;worker-1&#39;, &#39;Rank&#39;: 1, &#39;Local_rank&#39;: 0, &#39;Cross_rank&#39;:1,
</span></span></span><span class=line><span class=cl><span class=s2>            &#39;Size&#39;:2, &#39;Local_size&#39;:1, &#39;Cross_size&#39;:2}
</span></span></span><span class=line><span class=cl><span class=s2>        ]
</span></span></span><span class=line><span class=cl><span class=s2>    :type hosts_alloc: list(dict)
</span></span></span><span class=line><span class=cl><span class=s2>    :param remote_host_names: names that are resolved to one of the addresses
</span></span></span><span class=line><span class=cl><span class=s2>    of remote hosts interfaces.
</span></span></span><span class=line><span class=cl><span class=s2>    :param _run_command: command to execute
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_exec_command</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>slot_info</span><span class=p>,</span> <span class=n>events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>index</span> <span class=o>=</span> <span class=n>slot_info</span><span class=o>.</span><span class=n>rank</span>
</span></span><span class=line><span class=cl>        <span class=n>host_name</span> <span class=o>=</span> <span class=n>slot_info</span><span class=o>.</span><span class=n>hostname</span>
</span></span><span class=line><span class=cl>        <span class=n>host_address</span> <span class=o>=</span> <span class=n>network</span><span class=o>.</span><span class=n>resolve_host_address</span><span class=p>(</span><span class=n>host_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>local_addresses</span> <span class=o>=</span> <span class=n>network</span><span class=o>.</span><span class=n>get_local_host_addresses</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># 需要构建远程命令</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>host_address</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>local_addresses</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>local_command</span> <span class=o>=</span> <span class=n>quote</span><span class=p>(</span><span class=s1>&#39;cd </span><span class=si>{pwd}</span><span class=s1> &gt; /dev/null 2&gt;&amp;1 ; </span><span class=si>{command}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>                                  <span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>pwd</span><span class=o>=</span><span class=n>os</span><span class=o>.</span><span class=n>getcwd</span><span class=p>(),</span> <span class=n>command</span><span class=o>=</span><span class=n>command</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>command</span> <span class=o>=</span> <span class=n>get_remote_command</span><span class=p>(</span><span class=n>local_command</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                         <span class=n>host</span><span class=o>=</span><span class=n>host_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                         <span class=n>port</span><span class=o>=</span><span class=n>settings</span><span class=o>.</span><span class=n>ssh_port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                         <span class=n>identity_file</span><span class=o>=</span><span class=n>settings</span><span class=o>.</span><span class=n>ssh_identity_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Redirect output if requested</span>
</span></span><span class=line><span class=cl>        <span class=c1># 调整输入输出，利用 safe_shell_exec.execute 来实现安全执行能力</span>
</span></span><span class=line><span class=cl>        <span class=n>stdout</span> <span class=o>=</span> <span class=n>stderr</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=n>stdout_file</span> <span class=o>=</span> <span class=n>stderr_file</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>output_filename</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>padded_rank</span> <span class=o>=</span> <span class=n>_pad_rank</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>settings</span><span class=o>.</span><span class=n>num_proc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>output_dir_rank</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>output_filename</span><span class=p>,</span> <span class=s1>&#39;rank.</span><span class=si>{rank}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>rank</span><span class=o>=</span><span class=n>padded_rank</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>output_dir_rank</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>os</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>output_dir_rank</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>stdout_file</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>output_dir_rank</span><span class=p>,</span> <span class=s1>&#39;stdout&#39;</span><span class=p>),</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>stderr_file</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>output_dir_rank</span><span class=p>,</span> <span class=s1>&#39;stderr&#39;</span><span class=p>),</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>stdout</span> <span class=o>=</span> <span class=n>MultiFile</span><span class=p>([</span><span class=n>sys</span><span class=o>.</span><span class=n>stdout</span><span class=p>,</span> <span class=n>stdout_file</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>stderr</span> <span class=o>=</span> <span class=n>MultiFile</span><span class=p>([</span><span class=n>sys</span><span class=o>.</span><span class=n>stderr</span><span class=p>,</span> <span class=n>stderr_file</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 实现安全执行能力</span>
</span></span><span class=line><span class=cl>            <span class=n>exit_code</span> <span class=o>=</span> <span class=n>safe_shell_exec</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>command</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>index</span><span class=o>=</span><span class=n>index</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>stdout</span><span class=o>=</span><span class=n>stdout</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>stderr</span><span class=o>=</span><span class=n>stderr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>events</span><span class=o>=</span><span class=n>events</span><span class=p>,</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>exit_code</span><span class=p>,</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>_exec_command</span></span></span></code></pre></td></tr></table></div></div><h4 id=442-get_remote_command>4.4.2 get_remote_command</h4><p>本函数是针对远程 host，获取如何在其上运行的方式。这个函数是比较新加入的，具体和 kubeflow mpi operator 也相关，以后有机会再分析。</p><div class=highlight id=id-18><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>SSH_COMMAND_PREFIX</span> <span class=o>=</span> <span class=s1>&#39;ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_ssh_command</span><span class=p>(</span><span class=n>local_command</span><span class=p>,</span> <span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>identity_file</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>timeout_s</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>port_arg</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;-p </span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>if</span> <span class=n>port</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>identity_file_arg</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;-i </span><span class=si>{</span><span class=n>identity_file</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>if</span> <span class=n>identity_file</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>timeout_arg</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;-o ConnectTimeout=</span><span class=si>{</span><span class=n>timeout_s</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>if</span> <span class=n>timeout_s</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>SSH_COMMAND_PREFIX</span><span class=si>}</span><span class=s1> </span><span class=si>{</span><span class=n>host</span><span class=si>}</span><span class=s1> </span><span class=si>{</span><span class=n>port_arg</span><span class=si>}</span><span class=s1> </span><span class=si>{</span><span class=n>identity_file_arg</span><span class=si>}</span><span class=s1> </span><span class=si>{</span><span class=n>timeout_arg</span><span class=si>}</span><span class=s1> </span><span class=si>{</span><span class=n>local_command</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_remote_command</span><span class=p>(</span><span class=n>local_command</span><span class=p>,</span> <span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>identity_file</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>timeout_s</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>env_util</span><span class=o>.</span><span class=n>KUBEFLOW_MPI_EXEC</span><span class=si>}</span><span class=s1> </span><span class=si>{</span><span class=n>host</span><span class=si>}</span><span class=s1> </span><span class=si>{</span><span class=n>local_command</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>if</span> <span class=n>env_util</span><span class=o>.</span><span class=n>is_kubeflow_mpi</span><span class=p>()</span> \
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=n>get_ssh_command</span><span class=p>(</span><span class=n>local_command</span><span class=p>,</span> <span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>identity_file</span><span class=p>,</span> <span class=n>timeout_s</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>大致逻辑如下：</p><div class=highlight id=id-19><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>command</span><span class=w>  </span><span class=p>:</span><span class=w>  </span><span class=n>python</span><span class=w> </span><span class=n>train</span><span class=p>.</span><span class=na>py</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>+---------+-------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>                       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=n>get_remote_command</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>                       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>+---------+-------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>ssh</span><span class=w> </span><span class=o>-</span><span class=n>o</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=n>python</span><span class=w> </span><span class=n>train</span><span class=p>.</span><span class=na>py</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>+---------+--------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=n>safe_shell_exec</span><span class=p>.</span><span class=na>execute</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>+------------------------+</span></span></span></code></pre></td></tr></table></div></div><h3 id=45-使用-gloo-执行命令>4.5 使用 gloo 执行命令</h3><p>获取到了可执行环境 exec_command 与 执行命令 command 之后，就可以使用 gloo 来执行命令了。</p><p>每个 command 都是被 exec_command 来执行。</p><p>launch_gloo 来获取命令，各种配置信息，网卡信息（nics，比如 {&rsquo;lo&rsquo;}），host信息等，然后开始运行，就是开始运行我们的训练代码了，具体是：</p><ul><li>建立 RendezvousServer，这个会被底层 Gloo C++ 环境使用到;</li><li>host_alloc_plan = get_host_assignments 来根据host进行分配slot，就是horovod的哪个rank应该在哪个host上的哪个slot之上运行；</li><li>get_run_command 获取到可执行命令；</li><li>slot_info_to_command_fn 来得到在slot之上可执行的 slot command；</li><li>依据 slot_info_to_command_fn 构建 args_list，这个 list 之中，每一个arg就是一个 slot command；</li><li>多线程执行，在每一个 exec_command 之上执行每一个 arg（slot command）；</li></ul><p>代码如下：</p><div class=highlight id=id-20><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>launch_gloo</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>exec_command</span><span class=p>,</span> <span class=n>settings</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>env</span><span class=p>,</span> <span class=n>server_ip</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Launches the given command multiple times using gloo.
</span></span></span><span class=line><span class=cl><span class=s2>    Each command is launched via exec_command.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param command: command to launch
</span></span></span><span class=line><span class=cl><span class=s2>    :param exec_command: means to execute a single command
</span></span></span><span class=line><span class=cl><span class=s2>    :param settings: settings for the distribution
</span></span></span><span class=line><span class=cl><span class=s2>    :param nics: common interfaces
</span></span></span><span class=line><span class=cl><span class=s2>    :param env: environment to use
</span></span></span><span class=line><span class=cl><span class=s2>    :param server_ip: ip to use for rendezvous server
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Make the output directory if it does not exist</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>output_filename</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>_mkdir_p</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>output_filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># start global rendezvous server and get port that it is listening on</span>
</span></span><span class=line><span class=cl>    <span class=c1># 建立 RendezvousServer，这个会被底层 Gloo C++ 环境使用到</span>
</span></span><span class=line><span class=cl>    <span class=n>rendezvous</span> <span class=o>=</span> <span class=n>RendezvousServer</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>verbose</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># allocate processes into slots</span>
</span></span><span class=line><span class=cl>    <span class=c1># 来根据host进行分配slot，就是horovod的哪个rank应该在哪个host上的哪个slot之上运行</span>
</span></span><span class=line><span class=cl>    <span class=n>hosts</span> <span class=o>=</span> <span class=n>parse_hosts</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>hosts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>host_alloc_plan</span> <span class=o>=</span> <span class=n>get_host_assignments</span><span class=p>(</span><span class=n>hosts</span><span class=p>,</span> <span class=n>settings</span><span class=o>.</span><span class=n>num_proc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># start global rendezvous server and get port that it is listening on</span>
</span></span><span class=line><span class=cl>    <span class=n>global_rendezv_port</span> <span class=o>=</span> <span class=n>rendezvous</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>rendezvous</span><span class=o>.</span><span class=n>init</span><span class=p>(</span><span class=n>host_alloc_plan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取到可执行命令</span>
</span></span><span class=line><span class=cl>    <span class=n>run_command</span> <span class=o>=</span> <span class=n>get_run_command</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>server_ip</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>global_rendezv_port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 得到在slot之上可执行的 slot command</span>
</span></span><span class=line><span class=cl>    <span class=n>slot_info_to_command</span> <span class=o>=</span> <span class=n>_slot_info_to_command_fn</span><span class=p>(</span><span class=n>run_command</span><span class=p>,</span> <span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>event</span> <span class=o>=</span> <span class=n>register_shutdown_event</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># 依据 slot_info_to_command_fn 构建 args_list，这个 list 之中，每一个arg就是一个 slot command</span>
</span></span><span class=line><span class=cl>    <span class=n>args_list</span> <span class=o>=</span> <span class=p>[[</span><span class=n>slot_info_to_command</span><span class=p>(</span><span class=n>slot_info</span><span class=p>),</span> <span class=n>slot_info</span><span class=p>,</span> <span class=p>[</span><span class=n>event</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>                 <span class=k>for</span> <span class=n>slot_info</span> <span class=ow>in</span> <span class=n>host_alloc_plan</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># If an error occurs in one thread, entire process will be terminated.</span>
</span></span><span class=line><span class=cl>    <span class=c1># Otherwise, threads will keep running.</span>
</span></span><span class=line><span class=cl>    <span class=c1># 多线程执行，在每一个 exec_command 之上执行每一个 arg（slot command）</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>threads</span><span class=o>.</span><span class=n>execute_function_multithreaded</span><span class=p>(</span><span class=n>exec_command</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                 <span class=n>args_list</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                 <span class=n>block_until_all_done</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>res</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>item</span><span class=p>:</span> <span class=n>item</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=n>exit_code</span><span class=p>,</span> <span class=n>timestamp</span> <span class=o>=</span> <span class=n>value</span></span></span></code></pre></td></tr></table></div></div><p>具体 HostInfo.from_string 信息如下：</p><div class=highlight id=id-21><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>HostInfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>hostname</span><span class=p>,</span> <span class=n>slots</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>hostname</span> <span class=o>=</span> <span class=n>hostname</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>slots</span> <span class=o>=</span> <span class=n>slots</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>from_string</span><span class=p>(</span><span class=n>host_string</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>hostname</span><span class=p>,</span> <span class=n>slots</span> <span class=o>=</span> <span class=n>host_string</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>HostInfo</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=n>slots</span><span class=p>))</span></span></span></code></pre></td></tr></table></div></div><h5 id=4512-分配方案>4.5.1.2 分配方案</h5><p>get_host_assignments 会依据 host 和 process capacities (slots) 来给 Horovod 之中的进程分配，即给出一个 horovod rank 和 slot 的对应关系。设置了几个 np，就有几个 slot。</p><p>给出的分配方案类似如下，这样就知道了哪个rank对应于哪个host上的哪个slot：</p><div class=highlight id=id-22><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>[
</span></span><span class=line><span class=cl>  SlotInfo(hostname=&#39;h1&#39;, rank=0, local_rank=0, cross_rank=0, size=2, local_size=2, coress_size=1),
</span></span><span class=line><span class=cl>	SlotInfo(hostname=&#39;h2&#39;, rank=1, local_rank=0, cross_rank=0, size=2, local_size=2, coress_size=1),
</span></span><span class=line><span class=cl>]</span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-23><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_host_assignments</span><span class=p>(</span><span class=n>hosts</span><span class=p>,</span> <span class=n>min_np</span><span class=p>,</span> <span class=n>max_np</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Assign hosts with process capacities (slots) to ranks in the Horovod process.
</span></span></span><span class=line><span class=cl><span class=s2>    This function will try to allocate as many as possible processes on the same host to leverage local network.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param hosts: list of HostInfo objects describing host and slot capacity
</span></span></span><span class=line><span class=cl><span class=s2>    :type hosts: list[HostInfo]
</span></span></span><span class=line><span class=cl><span class=s2>    :param min_np: minimum number of processes to be allocated
</span></span></span><span class=line><span class=cl><span class=s2>    :param max_np: (optional) maximum number of processes to be allocated
</span></span></span><span class=line><span class=cl><span class=s2>    :return: a list of the allocation of process on hosts in a `SlotInfo` object.
</span></span></span><span class=line><span class=cl><span class=s2>    :rtype: list[SlotInfo]
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>host_ranks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>cross_ranks</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rank</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=c1># 依据 hosts 信息构建 rank, local rank, cross rank(hierarchical allreduce所需要)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>host_info</span> <span class=ow>in</span> <span class=n>hosts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ranks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>local_rank</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>host_info</span><span class=o>.</span><span class=n>slots</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>rank</span> <span class=o>==</span> <span class=n>max_np</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>ranks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>rank</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>rank</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>cross_ranks_at_local</span> <span class=o>=</span> <span class=n>cross_ranks</span><span class=p>[</span><span class=n>local_rank</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>cross_ranks_at_local</span><span class=p>[</span><span class=n>host_info</span><span class=o>.</span><span class=n>hostname</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>cross_ranks_at_local</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>host_ranks</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>host_info</span><span class=p>,</span> <span class=n>ranks</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>world_size</span> <span class=o>=</span> <span class=n>rank</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 给出一个 horovod rank 和 slot 的对应关系。返回一个alloc_list，每个SlotInfo包括各种rank信息</span>
</span></span><span class=line><span class=cl>    <span class=n>alloc_list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>host_info</span><span class=p>,</span> <span class=n>ranks</span> <span class=ow>in</span> <span class=n>host_ranks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>local_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>ranks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>local_rank</span><span class=p>,</span> <span class=n>rank</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>ranks</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>cross_ranks_at_local</span> <span class=o>=</span> <span class=n>cross_ranks</span><span class=p>[</span><span class=n>local_rank</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>cross_rank</span> <span class=o>=</span> <span class=n>cross_ranks_at_local</span><span class=p>[</span><span class=n>host_info</span><span class=o>.</span><span class=n>hostname</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>cross_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>cross_ranks_at_local</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>alloc_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>SlotInfo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>hostname</span><span class=o>=</span><span class=n>host_info</span><span class=o>.</span><span class=n>hostname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>rank</span><span class=o>=</span><span class=n>rank</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>local_rank</span><span class=o>=</span><span class=n>local_rank</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>cross_rank</span><span class=o>=</span><span class=n>cross_rank</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>size</span><span class=o>=</span><span class=n>world_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>local_size</span><span class=o>=</span><span class=n>local_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>cross_size</span><span class=o>=</span><span class=n>cross_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>alloc_list</span></span></span></code></pre></td></tr></table></div></div><h4 id=452-得到运行命令>4.5.2 得到运行命令</h4><p>get_run_command 是从环境变量中得到 Gloo 的变量，然后加到 command 之上。此步完成之后，得到类似如下命令：</p><div class=highlight id=id-24><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>HOROVOD_GLOO_RENDEZVOUS_ADDR</span><span class=o>=</span>1.1.1.1 <span class=nv>HOROVOD_GLOO_RENDEZVOUS_PORT</span><span class=o>=</span><span class=m>2222</span> <span class=nv>HOROVOD_CPU_OPERATIONS</span><span class=o>=</span>gloo <span class=nv>HOROVOD_GLOO_IFACE</span><span class=o>=</span>lo <span class=nv>HOROVOD_CONTROLLER</span><span class=o>=</span>gloo python train.py</span></span></code></pre></td></tr></table></div></div><p>可以把这个格式缩写为：{horovod_gloo_env} command。</p><p>代码为：</p><div class=highlight id=id-25><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_run_env_vars</span><span class=p>(</span><span class=n>server_ip</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>elastic</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 从环境变量中得到 Gloo 的变量</span>
</span></span><span class=line><span class=cl>    <span class=n>run_envs</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;HOROVOD_GLOO_RENDEZVOUS_ADDR&#39;</span><span class=p>:</span> <span class=n>server_ip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;HOROVOD_GLOO_RENDEZVOUS_PORT&#39;</span><span class=p>:</span> <span class=n>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;HOROVOD_CONTROLLER&#39;</span><span class=p>:</span> <span class=s2>&#34;gloo&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;HOROVOD_CPU_OPERATIONS&#39;</span><span class=p>:</span> <span class=s2>&#34;gloo&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;HOROVOD_GLOO_IFACE&#39;</span><span class=p>:</span> <span class=nb>list</span><span class=p>(</span><span class=n>nics</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span>   <span class=c1># TODO: add multiple ifaces in future</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;NCCL_SOCKET_IFNAME&#39;</span><span class=p>:</span> <span class=s1>&#39;,&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>nics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>elastic</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>run_envs</span><span class=p>[</span><span class=s2>&#34;HOROVOD_ELASTIC&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>run_envs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_run_command</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>server_ip</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>elastic</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>env_vars</span> <span class=o>=</span> <span class=n>create_run_env_vars</span><span class=p>(</span><span class=n>server_ip</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>elastic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>env_string</span> <span class=o>=</span> <span class=s2>&#34; &#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>k</span><span class=si>}</span><span class=s2>=</span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>env_vars</span><span class=o>.</span><span class=n>items</span><span class=p>()])</span>
</span></span><span class=line><span class=cl>    <span class=n>run_command</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{env_string}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{command}</span><span class=s1>&#39;</span>  <span class=c1># expect a lot of environment variables</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>env_string</span><span class=o>=</span><span class=n>env_string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>command</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>quote</span><span class=p>(</span><span class=n>par</span><span class=p>)</span> <span class=k>for</span> <span class=n>par</span> <span class=ow>in</span> <span class=n>command</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>run_command</span></span></span></code></pre></td></tr></table></div></div><h4 id=453-得到slot运行命令>4.5.3 得到slot运行命令</h4><p>得到运行命令之后，这里会结合 horovod env 和 env，以及slot 分配情况 进一步修改为适合 gloo 运行的方式。就是可以在具体每一个slot上运行的命令。</p><p>可以把这个格式缩写为：{horovod_gloo_env} {horovod_rendez_env} {env} run_command。</p><p>此步完成之后，得到类似如下：</p><div class=highlight id=id-26><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>HOROVOD_HOSTNAME</span><span class=o>=</span>1.1.1.1 <span class=nv>HOROVOD_RANK</span><span class=o>=</span><span class=m>1</span> <span class=nv>HOROVOD_SIZE</span><span class=o>=</span><span class=m>2</span> <span class=nv>HOROVOD_LOCAL_RANK</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>SHELL</span><span class=o>=</span>/bin/bash <span class=nv>PATH</span><span class=o>=</span>XXXX <span class=nv>USER</span><span class=o>=</span>xxx <span class=nv>PWD</span><span class=o>=</span>xxx <span class=nv>SSH_CONNECTION</span><span class=o>=</span><span class=s2>&#34;1.1.1.1 11 2.2.2.2 22&#34;</span> <span class=nv>HOME</span><span class=o>=</span>xxx <span class=nv>SSH_CLIENZT</span><span class=o>=</span>xxxx
</span></span><span class=line><span class=cl><span class=nv>HOROVOD_GLOO_IFACE</span><span class=o>=</span>lo <span class=nv>NCCL_SOCKET_IFNAME</span><span class=o>=</span>lo
</span></span><span class=line><span class=cl><span class=nv>HOROVOD_GLOO_RENDEZVOUS_ADDR</span><span class=o>=</span>1.1.1.1 <span class=nv>HOROVOD_GLOO_RENDEZVOUS_PORT</span><span class=o>=</span><span class=m>2222</span> <span class=nv>HOROVOD_CPU_OPERATIONS</span><span class=o>=</span>gloo <span class=nv>HOROVOD_GLOO_IFACE</span><span class=o>=</span>lo <span class=nv>HOROVOD_CONTROLLER</span><span class=o>=</span>gloo python train.py</span></span></code></pre></td></tr></table></div></div><p>具体代码如下：</p><div class=highlight id=id-27><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>_slot_info_to_command_fn</span><span class=p>(</span><span class=n>run_command</span><span class=p>,</span> <span class=n>env</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># TODO: Workaround for over-buffered outputs. Investigate how mpirun avoids this problem.</span>
</span></span><span class=line><span class=cl>    <span class=n>env</span> <span class=o>=</span> <span class=n>copy</span><span class=o>.</span><span class=n>copy</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>  <span class=c1># copy env so we do not leak env modifications</span>
</span></span><span class=line><span class=cl>    <span class=n>env</span><span class=p>[</span><span class=s1>&#39;PYTHONUNBUFFERED&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;1&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>slot_info_to_command</span><span class=p>(</span><span class=n>slot_info</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        Given a slot_info, creates a command used by gloo to launch a single job.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        :param slot_info: host and slot to execute the run command on
</span></span></span><span class=line><span class=cl><span class=s2>        :return:
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>env_vars</span> <span class=o>=</span> <span class=n>create_slot_env_vars</span><span class=p>(</span><span class=n>slot_info</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>horovod_rendez_env</span> <span class=o>=</span> <span class=s2>&#34; &#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>k</span><span class=si>}</span><span class=s2>=</span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>env_vars</span><span class=o>.</span><span class=n>items</span><span class=p>()])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;</span><span class=si>{horovod_env}</span><span class=s1> </span><span class=si>{env}</span><span class=s1> </span><span class=si>{run_command}</span><span class=s1>&#39;</span> <span class=o>.</span><span class=n>format</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>horovod_env</span><span class=o>=</span><span class=n>horovod_rendez_env</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>env</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;</span><span class=si>%s</span><span class=s1>=</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>quote</span><span class=p>(</span><span class=n>value</span><span class=p>))</span> <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>env</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                          <span class=k>if</span> <span class=n>env_util</span><span class=o>.</span><span class=n>is_exportable</span><span class=p>(</span><span class=n>key</span><span class=p>)]),</span>
</span></span><span class=line><span class=cl>            <span class=n>run_command</span><span class=o>=</span><span class=n>run_command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>slot_info_to_command</span></span></span></code></pre></td></tr></table></div></div><h4 id=454-多线程调用命令>4.5.4 多线程调用命令</h4><p>这就是启动了多线程进行调用。gloo_run 的注释说的很清楚：在调用 execute_function_multithreaded 时，每一个thread将使用 ssh 命令在远程host之上启动训练job。</p><p>回忆下之前我们在“构建可执行环境” 中提到：利用 get_remote_command 来生成相关远程可运行环境，比如在训练脚本前面加上 &lsquo;ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no&rsquo;。大家就理解了如何在远端执行。</p><p>在本地运行，则命令大致为：</p><div class=highlight id=id-28><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> /code directory &gt; /dev/null <span class=m>2</span> &gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>HOROVOD_HOSTNAME</span><span class=o>=</span>1.1.1.1 <span class=nv>HOROVOD_RANK</span><span class=o>=</span><span class=m>1</span> <span class=nv>HOROVOD_SIZE</span><span class=o>=</span><span class=m>2</span> <span class=nv>HOROVOD_LOCAL_RANK</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>SHELL</span><span class=o>=</span>/bin/bash <span class=nv>PATH</span><span class=o>=</span>XXXX <span class=nv>USER</span><span class=o>=</span>xxx <span class=nv>PWD</span><span class=o>=</span>xxx <span class=nv>SSH_CONNECTION</span><span class=o>=</span><span class=s2>&#34;1.1.1.1 11 2.2.2.2 22&#34;</span> <span class=nv>HOME</span><span class=o>=</span>xxx <span class=nv>SSH_CLIENZT</span><span class=o>=</span>xxxx
</span></span><span class=line><span class=cl><span class=nv>HOROVOD_GLOO_IFACE</span><span class=o>=</span>lo <span class=nv>NCCL_SOCKET_IFNAME</span><span class=o>=</span>lo
</span></span><span class=line><span class=cl><span class=nv>HOROVOD_GLOO_RENDEZVOUS_ADDR</span><span class=o>=</span>1.1.1.1 <span class=nv>HOROVOD_GLOO_RENDEZVOUS_PORT</span><span class=o>=</span><span class=m>2222</span> <span class=nv>HOROVOD_CPU_OPERATIONS</span><span class=o>=</span>gloo <span class=nv>HOROVOD_GLOO_IFACE</span><span class=o>=</span>lo <span class=nv>HOROVOD_CONTROLLER</span><span class=o>=</span>gloo python train.py</span></span></code></pre></td></tr></table></div></div><p>在远端运行，命令就需要加上 ssh 信息，大致为：</p><div class=highlight id=id-29><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ssh -o <span class=nv>PasswordAuthentication</span><span class=o>=</span>no -o <span class=nv>StrictHostKeyChecking</span><span class=o>=</span>no 1.1.1.1
</span></span><span class=line><span class=cl><span class=nb>cd</span> /code directory &gt; /dev/null <span class=m>2</span> &gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>HOROVOD_HOSTNAME</span><span class=o>=</span>1.1.1.1 <span class=nv>HOROVOD_RANK</span><span class=o>=</span><span class=m>1</span> <span class=nv>HOROVOD_SIZE</span><span class=o>=</span><span class=m>2</span> <span class=nv>HOROVOD_LOCAL_RANK</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>SHELL</span><span class=o>=</span>/bin/bash <span class=nv>PATH</span><span class=o>=</span>XXXX <span class=nv>USER</span><span class=o>=</span>xxx <span class=nv>PWD</span><span class=o>=</span>xxx <span class=nv>SSH_CONNECTION</span><span class=o>=</span><span class=s2>&#34;1.1.1.1 11 2.2.2.2 22&#34;</span> <span class=nv>HOME</span><span class=o>=</span>xxx <span class=nv>SSH_CLIENZT</span><span class=o>=</span>xxxx
</span></span><span class=line><span class=cl><span class=nv>HOROVOD_GLOO_IFACE</span><span class=o>=</span>lo <span class=nv>NCCL_SOCKET_IFNAME</span><span class=o>=</span>lo
</span></span><span class=line><span class=cl><span class=nv>HOROVOD_GLOO_RENDEZVOUS_ADDR</span><span class=o>=</span>1.1.1.1 <span class=nv>HOROVOD_GLOO_RENDEZVOUS_PORT</span><span class=o>=</span><span class=m>2222</span> <span class=nv>HOROVOD_CPU_OPERATIONS</span><span class=o>=</span>gloo <span class=nv>HOROVOD_GLOO_IFACE</span><span class=o>=</span>lo <span class=nv>HOROVOD_CONTROLLER</span><span class=o>=</span>gloo python train.py</span></span></code></pre></td></tr></table></div></div><p>execute_function_multithreaded 具体代码如下，其中：</p><ul><li><code>fn</code> 就是前面提到的程序运行环境（能力）<code>exec_command</code>。</li><li><code>fn(*arg[:-1])</code> 就是在 <code>exec_command</code> 之中运行<code>slot_info_to_command</code>。</li></ul><div class=highlight id=id-30><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_function_multithreaded</span><span class=p>(</span><span class=n>fn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                   <span class=n>args_list</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                   <span class=n>block_until_all_done</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                   <span class=n>max_concurrent_executions</span><span class=o>=</span><span class=mi>1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Executes fn in multiple threads each with one set of the args in the
</span></span></span><span class=line><span class=cl><span class=s2>    args_list.
</span></span></span><span class=line><span class=cl><span class=s2>    :param fn: function to be executed
</span></span></span><span class=line><span class=cl><span class=s2>    :type fn:
</span></span></span><span class=line><span class=cl><span class=s2>    :param args_list:
</span></span></span><span class=line><span class=cl><span class=s2>    :type args_list: list(list)
</span></span></span><span class=line><span class=cl><span class=s2>    :param block_until_all_done: if is True, function will block until all the
</span></span></span><span class=line><span class=cl><span class=s2>    threads are done and will return the results of each thread&#39;s execution.
</span></span></span><span class=line><span class=cl><span class=s2>    :type block_until_all_done: bool
</span></span></span><span class=line><span class=cl><span class=s2>    :param max_concurrent_executions:
</span></span></span><span class=line><span class=cl><span class=s2>    :type max_concurrent_executions: int
</span></span></span><span class=line><span class=cl><span class=s2>    :return:
</span></span></span><span class=line><span class=cl><span class=s2>    If block_until_all_done is False, returns None. If block_until_all_done is
</span></span></span><span class=line><span class=cl><span class=s2>    True, function returns the dict of results.
</span></span></span><span class=line><span class=cl><span class=s2>        {
</span></span></span><span class=line><span class=cl><span class=s2>            index: execution result of fn with args_list[index]
</span></span></span><span class=line><span class=cl><span class=s2>        }
</span></span></span><span class=line><span class=cl><span class=s2>    :rtype: dict
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>result_queue</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>Queue</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>worker_queue</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>Queue</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>arg</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>args_list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>arg</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>worker_queue</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fn_execute</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>arg</span> <span class=o>=</span> <span class=n>worker_queue</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>block</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=n>queue</span><span class=o>.</span><span class=n>Empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=n>exec_index</span> <span class=o>=</span> <span class=n>arg</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=c1># fn 就是前面提到的程序运行环境（能力）exec_command</span>
</span></span><span class=line><span class=cl>            <span class=c1># fn(*arg[:-1])是在 exec_command 之中运行 slot_info_to_command</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>=</span> <span class=n>fn</span><span class=p>(</span><span class=o>*</span><span class=n>arg</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>result_queue</span><span class=o>.</span><span class=n>put</span><span class=p>((</span><span class=n>exec_index</span><span class=p>,</span> <span class=n>res</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>threads</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>number_of_threads</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>max_concurrent_executions</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>args_list</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 在多线程中执行 fn_execute</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>number_of_threads</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span> <span class=o>=</span> <span class=n>in_thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>fn_execute</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=ow>not</span> <span class=n>block_until_all_done</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>threads</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>thread</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Returns the results only if block_until_all_done is set.</span>
</span></span><span class=line><span class=cl>    <span class=c1># 如果有设置，则 block 等待</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>block_until_all_done</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Because join() cannot be interrupted by signal, a single join()</span>
</span></span><span class=line><span class=cl>        <span class=c1># needs to be separated into join()s with timeout in a while loop.</span>
</span></span><span class=line><span class=cl>        <span class=n>have_alive_child</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>have_alive_child</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>have_alive_child</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>t</span><span class=o>.</span><span class=n>is_alive</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                    <span class=n>have_alive_child</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=n>result_queue</span><span class=o>.</span><span class=n>empty</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>item</span> <span class=o>=</span> <span class=n>result_queue</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=p>[</span><span class=n>item</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span> <span class=o>=</span> <span class=n>item</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span></span></span></code></pre></td></tr></table></div></div><p>python train.py 就会进入到我们的训练代码。</p><p>大致逻辑如下图，可以看到，结合了各种信息之后，构建了一个可以执行的结果，然后多host执行：</p><ul><li>图左面，是从 参数中获取 host 等信息，然后解析出 slot 信息；</li><li>图右边，是从 python train.py 这个待运行的命令，基于各种配置来生成可以执行命令环境。如果是远程，就得生成 相关远程可运行命令环境（包括切换目录，远程执行等等）；</li><li>图中间，是从 python train.py 这个待运行的命令，经过添加 env 信息，gloo 信息。然后结合 左面的 slot 信息 和 右面 的可以执行命令环境 之后，得到了可以在多线程上运行，从而在 多slot 运行的命令。</li></ul><div class=highlight id=id-31><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>args</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=err>&#39;</span><span class=n>10</span><span class=p>.</span><span class=na>11</span><span class=p>.</span><span class=na>11</span><span class=p>.</span><span class=na>11</span><span class=p>:</span><span class=n>4</span><span class=p>,</span><span class=n>10</span><span class=p>.</span><span class=na>11</span><span class=p>.</span><span class=na>11</span><span class=p>.</span><span class=na>12</span><span class=p>:</span><span class=n>4</span><span class=err>&#39;</span><span class=w>            </span><span class=n>python</span><span class=w> </span><span class=n>train</span><span class=p>.</span><span class=na>py</span><span class=w>                  </span><span class=n>command</span><span class=w>  </span><span class=p>:</span><span class=w>  </span><span class=n>python</span><span class=w> </span><span class=n>train</span><span class=p>.</span><span class=na>py</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=o>+</span><span class=w>                                     </span><span class=o>+</span><span class=w>                                     </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=n>v</span><span class=w>                                     </span><span class=n>v</span><span class=w>                                     </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>+----------+--------+</span><span class=w>                 </span><span class=o>+----------+----------+</span><span class=w>                </span><span class=o>+---------+-------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>|</span><span class=w>    </span><span class=n>parse_hosts</span><span class=w>    </span><span class=o>|</span><span class=w>                 </span><span class=o>|</span><span class=w>   </span><span class=n>get_run_command</span><span class=w>   </span><span class=o>|</span><span class=w>                </span><span class=o>|</span><span class=w>                       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>+----------+--------+</span><span class=w>                 </span><span class=o>|</span><span class=w>                     </span><span class=o>|</span><span class=w>                </span><span class=o>|</span><span class=w>  </span><span class=n>get_remote_command</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=o>|</span><span class=w>                          </span><span class=o>+----------+----------+</span><span class=w>                </span><span class=o>|</span><span class=w>                       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>                           </span><span class=o>+---------+-------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=n>v</span><span class=w>                                     </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>+------------+-----------+</span><span class=w>                         </span><span class=n>v</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>|</span><span class=w>  </span><span class=n>get_host_assignments</span><span class=w>  </span><span class=o>|</span><span class=w>                                                               </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w>               </span><span class=n>gloo</span><span class=w> </span><span class=n>python</span><span class=w> </span><span class=n>train</span><span class=p>.</span><span class=na>py</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>+------------+-----------+</span><span class=w>                         </span><span class=o>+</span><span class=w>                          </span><span class=n>ssh</span><span class=w> </span><span class=o>-</span><span class=n>o</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=n>python</span><span class=w> </span><span class=n>train</span><span class=p>.</span><span class=na>py</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>                                     </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=n>v</span><span class=w>                                     </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                       </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SlotInfo</span><span class=p>(</span><span class=n>hostname</span><span class=o>=</span><span class=err>&#39;</span><span class=n>h2</span><span class=err>&#39;</span><span class=p>,</span><span class=w> </span><span class=n>rank</span><span class=o>=</span><span class=n>1</span><span class=p>)</span><span class=w>                    </span><span class=n>v</span><span class=w>                                     </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=o>+</span><span class=w>                         </span><span class=o>+-----------+---------------+</span><span class=w>           </span><span class=o>+---------+--------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=o>|</span><span class=w>                         </span><span class=o>|</span><span class=w> </span><span class=n>_slot_info_to_command_fn</span><span class=w>  </span><span class=o>|</span><span class=w>           </span><span class=o>|</span><span class=n>safe_shell_exec</span><span class=p>.</span><span class=na>execute</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=o>+-----------------------&gt;</span><span class=w> </span><span class=o>|</span><span class=w>                           </span><span class=o>|</span><span class=w>           </span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                           </span><span class=o>+-----------+---------------+</span><span class=w>           </span><span class=o>+---------+--------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                       </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                       </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                       </span><span class=n>v</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                                                             </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                          </span><span class=n>HOROVOD_CONTROLLER</span><span class=o>=</span><span class=n>gloo</span><span class=w> </span><span class=n>python</span><span class=w> </span><span class=n>train</span><span class=p>.</span><span class=na>py</span><span class=w>            </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                       </span><span class=o>+</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                       </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                       </span><span class=o>|</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                       </span><span class=n>v</span><span class=w>                                     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                         </span><span class=o>+-------------+-------------------+</span><span class=w>                 </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                         </span><span class=o>|</span><span class=w>                                 </span><span class=o>|</span><span class=w>                 </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                         </span><span class=o>|</span><span class=w> </span><span class=n>execute_function_multithreaded</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=o>&lt;---------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                         </span><span class=o>|</span><span class=w>                                 </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                         </span><span class=o>+---------------------------------+</span></span></span></code></pre></td></tr></table></div></div><p>图示如下：</p><p><img loading=lazy src=https://github.com/jianye0428/hello-hugo/raw/master/img/posts/notes/2022-10-09_Horovod_3/Horovod-3_execute_function.png#center srcset="https://github.com/jianye0428/hello-hugo/raw/master/img/posts/notes/2022-10-09_Horovod_3/Horovod-3_execute_function.png#center, https://github.com/jianye0428/hello-hugo/raw/master/img/posts/notes/2022-10-09_Horovod_3/Horovod-3_execute_function.png#center 1.5x, https://github.com/jianye0428/hello-hugo/raw/master/img/posts/notes/2022-10-09_Horovod_3/Horovod-3_execute_function.png#center 2x" sizes=auto data-title="Execute function" data-alt="Execute function" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h3 id=46-c举例>4.6 C++举例</h3><p>我们给出一个底层代码，大家就进一步了解 Gloo 可以起到什么作用。</p><p>这个就是 Horovod 之中，rank 0 最终给其他 rank 发送构建好的 Tensor。</p><div class=highlight id=id-32><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=n>GlooController</span><span class=o>::</span><span class=n>SendFinalTensors</span><span class=p>(</span><span class=n>ResponseList</span><span class=o>&amp;</span> <span class=n>response_list</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Notify all nodes which tensors we&#39;d like to reduce at this step.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>encoded_response</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>ResponseList</span><span class=o>::</span><span class=n>SerializeToString</span><span class=p>(</span><span class=n>response_list</span><span class=p>,</span> <span class=n>encoded_response</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Boardcast the response length
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>encoded_response_length</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>encoded_response</span><span class=p>.</span><span class=n>length</span><span class=p>()</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>gloo</span><span class=o>::</span><span class=n>BroadcastOptions</span> <span class=n>opts</span><span class=p>(</span><span class=n>gloo_context_</span><span class=p>.</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>opts</span><span class=p>.</span><span class=n>setOutput</span><span class=p>(</span><span class=o>&amp;</span><span class=n>encoded_response_length</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>opts</span><span class=p>.</span><span class=n>setRoot</span><span class=p>(</span><span class=n>RANK_ZERO</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>gloo</span><span class=o>::</span><span class=n>broadcast</span><span class=p>(</span><span class=n>opts</span><span class=p>);</span> <span class=c1>// 广播给其他rank
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Boardcast the response
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>gloo</span><span class=o>::</span><span class=n>BroadcastOptions</span> <span class=n>opts</span><span class=p>(</span><span class=n>gloo_context_</span><span class=p>.</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>opts</span><span class=p>.</span><span class=n>setOutput</span><span class=p>((</span><span class=kt>uint8_t</span><span class=o>*</span><span class=p>)(</span><span class=n>encoded_response</span><span class=p>.</span><span class=n>c_str</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>                   <span class=n>encoded_response_length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>opts</span><span class=p>.</span><span class=n>setRoot</span><span class=p>(</span><span class=n>RANK_ZERO</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>gloo</span><span class=o>::</span><span class=n>broadcast</span><span class=p>(</span><span class=n>opts</span><span class=p>);</span> <span class=c1>// 广播给其他rank
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=5-mpi-实现>5 Mpi 实现</h2><h3 id=51-openmpi-库>5.1 openmpi 库</h3><p>horovod 这里主要依赖 openmpi。</p><ul><li>MPI：英文全称是Message Passing Interface，MPI是一个跨语言的通讯协议，用于编写并行计算机。支持点对点和广播。MPI是一个信息传递应用程序接口，包括协议和和语义说明，他们指明其如何在各种实现中发挥其特性。MPI的目标是高性能，大规模性，和可移植性。</li><li>openMPI：英文全称是open Message Passing Interface。openMPI是MPI的一种实现，一种库项目。</li></ul><p>MPI在Hovorod的角色比较特殊：</p><ul><li><p>一方面Horovod内集成了<strong>基于MPI的AllReduce</strong>，类似于NCCL，都是用作梯度规约；</p></li><li><p>另一方面，MPI可以用来在所有机器上<strong>启动多个进程(Hovorod里用Rank表示)，实现并行计算</strong>；</p></li></ul><h3 id=52-mpi_run-函数>5.2 mpi_run 函数</h3><p>此部分代码位于：horovod/runner/mpi_run.py。</p><p>首先摘录其关键代码如下，可以看出来其核心是运行 mpirun 命令。</p><div class=highlight id=id-33><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 我是下面大段代码中的关键代码！</span>
</span></span><span class=line><span class=cl><span class=n>mpirun_command</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;mpirun </span><span class=si>{basic_args}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;-np </span><span class=si>{num_proc}{ppn_arg}{hosts_arg}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{binding_args}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{mpi_args}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{mpi_ssh_args}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{tcp_intf_arg}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{nccl_socket_intf_arg}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{output_filename_arg}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{env}</span><span class=s1> </span><span class=si>{extra_mpi_args}</span><span class=s1> </span><span class=si>{command}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>basic_args</span><span class=o>=</span><span class=n>basic_args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>num_proc</span><span class=o>=</span><span class=n>settings</span><span class=o>.</span><span class=n>num_proc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>ppn_arg</span><span class=o>=</span><span class=n>ppn_arg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>hosts_arg</span><span class=o>=</span><span class=n>hosts_arg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>binding_args</span><span class=o>=</span><span class=n>binding_args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>mpi_args</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>mpi_impl_flags</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>tcp_intf_arg</span><span class=o>=</span><span class=n>tcp_intf_arg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>nccl_socket_intf_arg</span><span class=o>=</span><span class=n>nccl_socket_intf_arg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>mpi_ssh_args</span><span class=o>=</span><span class=n>mpi_ssh_args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>output_filename_arg</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>output</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>env</span><span class=o>=</span><span class=n>env_list</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>extra_mpi_args</span><span class=o>=</span><span class=n>settings</span><span class=o>.</span><span class=n>extra_mpi_args</span> <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>extra_mpi_args</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>command</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>quote</span><span class=p>(</span><span class=n>par</span><span class=p>)</span> <span class=k>for</span> <span class=n>par</span> <span class=ow>in</span> <span class=n>command</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Execute the mpirun command.</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>run_func_mode</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>exit_code</span> <span class=o>=</span> <span class=n>safe_shell_exec</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>mpirun_command</span><span class=p>,</span> <span class=n>env</span><span class=o>=</span><span class=n>env</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>stdout</span><span class=p>,</span> <span class=n>stderr</span><span class=o>=</span><span class=n>stderr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>execve</span><span class=p>(</span><span class=s1>&#39;/bin/sh&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;/bin/sh&#39;</span><span class=p>,</span> <span class=s1>&#39;-c&#39;</span><span class=p>,</span> <span class=n>mpirun_command</span><span class=p>],</span> <span class=n>env</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>就是依据各种配置以及参数来构建 mpirun 命令的所有参数，比如 ssh 的参数，mpi 参数，nccl 参数等等。</p><p>最后得到的 mpirun 命令举例如下：</p><div class=highlight id=id-34><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mpirun --allow-run-as-root --np <span class=m>2</span> -bind-to none -map-by slot <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -x <span class=nv>NCCL_DEBUG</span><span class=o>=</span>INFO -x LD_LIBRARY_PATH -x PATH <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -mca pml ob1 -mca btl ^openib <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    python train.py</span></span></code></pre></td></tr></table></div></div><p>具体代码如下，具体是：</p><div class=highlight id=id-35><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 上面代码是我之中的片段</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mpi_run</span><span class=p>(</span><span class=n>settings</span><span class=p>,</span> <span class=n>nics</span><span class=p>,</span> <span class=n>env</span><span class=p>,</span> <span class=n>command</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>stderr</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Runs mpi_run.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        settings: Settings for running MPI.
</span></span></span><span class=line><span class=cl><span class=s2>                  Note: settings.num_proc and settings.hosts must not be None.
</span></span></span><span class=line><span class=cl><span class=s2>        nics: Interfaces to include by MPI.
</span></span></span><span class=line><span class=cl><span class=s2>        env: Environment dictionary to use for running command.
</span></span></span><span class=line><span class=cl><span class=s2>        command: Command and arguments to run as a list of string.
</span></span></span><span class=line><span class=cl><span class=s2>        stdout: Stdout of the mpi process.
</span></span></span><span class=line><span class=cl><span class=s2>                Only used when settings.run_func_mode is True.
</span></span></span><span class=line><span class=cl><span class=s2>        stderr: Stderr of the mpi process.
</span></span></span><span class=line><span class=cl><span class=s2>                Only used when settings.run_func_mode is True.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 得到各种配置</span>
</span></span><span class=line><span class=cl>    <span class=n>mpi_impl_flags</span><span class=p>,</span> <span class=n>impl_binding_args</span><span class=p>,</span> <span class=n>mpi</span> <span class=o>=</span> <span class=n>_get_mpi_implementation_flags</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>tcp_flag</span><span class=p>,</span> <span class=n>env</span><span class=o>=</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>impi</span> <span class=o>=</span> <span class=n>_IMPI_IMPL</span> <span class=o>==</span> <span class=n>mpi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 处理ssh参数</span>
</span></span><span class=line><span class=cl>    <span class=n>ssh_args</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>ssh_port</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ssh_args</span> <span class=o>+=</span> <span class=p>[</span><span class=sa>f</span><span class=s1>&#39;-p </span><span class=si>{</span><span class=n>settings</span><span class=o>.</span><span class=n>ssh_port</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>ssh_identity_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ssh_args</span> <span class=o>+=</span> <span class=p>[</span><span class=sa>f</span><span class=s1>&#39;-i </span><span class=si>{</span><span class=n>settings</span><span class=o>.</span><span class=n>ssh_identity_file</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mpi_ssh_args</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ssh_args</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>joined_ssh_args</span> <span class=o>=</span> <span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ssh_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>mpi_ssh_args</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;-bootstrap=ssh -bootstrap-exec-args </span><span class=se>\&#34;</span><span class=si>{</span><span class=n>joined_ssh_args</span><span class=si>}</span><span class=se>\&#34;</span><span class=s1>&#39;</span> <span class=k>if</span> <span class=n>impi</span> <span class=k>else</span> <span class=sa>f</span><span class=s1>&#39;-mca plm_rsh_args </span><span class=se>\&#34;</span><span class=si>{</span><span class=n>joined_ssh_args</span><span class=si>}</span><span class=se>\&#34;</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 处理网络配置，网卡信息等</span>
</span></span><span class=line><span class=cl>    <span class=n>tcp_intf_arg</span> <span class=o>=</span> <span class=s1>&#39;-mca btl_tcp_if_include </span><span class=si>{nics}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>nics</span><span class=o>=</span><span class=s1>&#39;,&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>nics</span><span class=p>))</span> <span class=k>if</span> <span class=n>nics</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>impi</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>nccl_socket_intf_arg</span> <span class=o>=</span> <span class=s1>&#39;-</span><span class=si>{opt}</span><span class=s1> NCCL_SOCKET_IFNAME=</span><span class=si>{nics}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>opt</span><span class=o>=</span><span class=s1>&#39;genv&#39;</span> <span class=k>if</span> <span class=n>impi</span> <span class=k>else</span> <span class=s1>&#39;x&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>nics</span><span class=o>=</span><span class=s1>&#39;,&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>nics</span><span class=p>))</span> <span class=k>if</span> <span class=n>nics</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 处理host信息</span>
</span></span><span class=line><span class=cl>    <span class=c1># On large cluster runs (e.g. Summit), we need extra settings to work around OpenMPI issues</span>
</span></span><span class=line><span class=cl>    <span class=n>host_names</span><span class=p>,</span> <span class=n>host_to_slots</span> <span class=o>=</span> <span class=n>hosts</span><span class=o>.</span><span class=n>parse_hosts_and_slots</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>hosts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>impi</span> <span class=ow>and</span> <span class=n>host_names</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>host_names</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>_LARGE_CLUSTER_THRESHOLD</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>mpi_impl_flags</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;-mca plm_rsh_no_tree_spawn true&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>mpi_impl_flags</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;-mca plm_rsh_num_concurrent </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>host_names</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># if user does not specify any hosts, mpirun by default uses local host.</span>
</span></span><span class=line><span class=cl>    <span class=c1># There is no need to specify localhost.</span>
</span></span><span class=line><span class=cl>    <span class=n>hosts_arg</span> <span class=o>=</span> <span class=s1>&#39;-</span><span class=si>{opt}</span><span class=s1> </span><span class=si>{hosts}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>opt</span><span class=o>=</span><span class=s1>&#39;hosts&#39;</span> <span class=k>if</span> <span class=n>impi</span> <span class=k>else</span> <span class=s1>&#39;H&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>hosts</span><span class=o>=</span><span class=s1>&#39;,&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>host_names</span><span class=p>)</span> <span class=k>if</span> <span class=n>host_names</span> <span class=ow>and</span> <span class=n>impi</span> <span class=k>else</span> <span class=n>settings</span><span class=o>.</span><span class=n>hosts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 处理ppn配置</span>
</span></span><span class=line><span class=cl>    <span class=n>ppn_arg</span> <span class=o>=</span> <span class=s1>&#39; &#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>host_to_slots</span> <span class=ow>and</span> <span class=n>impi</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ppn</span> <span class=o>=</span> <span class=n>host_to_slots</span><span class=p>[</span><span class=n>host_names</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>h_name</span> <span class=ow>in</span> <span class=n>host_names</span><span class=p>[</span><span class=mi>1</span><span class=p>:]:</span>
</span></span><span class=line><span class=cl>        <span class=n>ppn_arg</span> <span class=o>=</span> <span class=s1>&#39; -ppn </span><span class=si>{}</span><span class=s1> &#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ppn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 处理超时配置</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>prefix_output_with_timestamp</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>impi</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>mpi_impl_flags</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;--timestamp-output&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>binding_args</span> <span class=o>=</span> <span class=n>settings</span><span class=o>.</span><span class=n>binding_args</span> <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>binding_args</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>impi</span> <span class=k>else</span> <span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>impl_binding_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 配置需要root身份运行</span>
</span></span><span class=line><span class=cl>    <span class=n>basic_args</span> <span class=o>=</span> <span class=s1>&#39;-l&#39;</span> <span class=k>if</span> <span class=n>impi</span> <span class=k>else</span> <span class=s1>&#39;--allow-run-as-root --tag-output&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>output_filename</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;-outfile-pattern&#39;</span> <span class=k>if</span> <span class=n>impi</span> <span class=k>else</span> <span class=s1>&#39;--output-filename&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>output_filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 构建环境信息列表</span>
</span></span><span class=line><span class=cl>    <span class=n>env_list</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span> <span class=k>if</span> <span class=n>impi</span> <span class=k>else</span> <span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;-x </span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>key</span> <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>env</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span> <span class=k>if</span> <span class=n>env_util</span><span class=o>.</span><span class=n>is_exportable</span><span class=p>(</span><span class=n>key</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 构建最终的 MPI 命令</span>
</span></span><span class=line><span class=cl>    <span class=c1># Pass all the env variables to the mpirun command.</span>
</span></span><span class=line><span class=cl>    <span class=n>mpirun_command</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;mpirun </span><span class=si>{basic_args}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;-np </span><span class=si>{num_proc}{ppn_arg}{hosts_arg}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{binding_args}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{mpi_args}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{mpi_ssh_args}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{tcp_intf_arg}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{nccl_socket_intf_arg}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{output_filename_arg}</span><span class=s1> &#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>{env}</span><span class=s1> </span><span class=si>{extra_mpi_args}</span><span class=s1> </span><span class=si>{command}</span><span class=s1>&#39;</span>  <span class=c1># expect a lot of environment variables</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>basic_args</span><span class=o>=</span><span class=n>basic_args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>num_proc</span><span class=o>=</span><span class=n>settings</span><span class=o>.</span><span class=n>num_proc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>ppn_arg</span><span class=o>=</span><span class=n>ppn_arg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>hosts_arg</span><span class=o>=</span><span class=n>hosts_arg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>binding_args</span><span class=o>=</span><span class=n>binding_args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>mpi_args</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>mpi_impl_flags</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>tcp_intf_arg</span><span class=o>=</span><span class=n>tcp_intf_arg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>nccl_socket_intf_arg</span><span class=o>=</span><span class=n>nccl_socket_intf_arg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>mpi_ssh_args</span><span class=o>=</span><span class=n>mpi_ssh_args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>output_filename_arg</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>output</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>env</span><span class=o>=</span><span class=n>env_list</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>extra_mpi_args</span><span class=o>=</span><span class=n>settings</span><span class=o>.</span><span class=n>extra_mpi_args</span> <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>extra_mpi_args</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>command</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>quote</span><span class=p>(</span><span class=n>par</span><span class=p>)</span> <span class=k>for</span> <span class=n>par</span> <span class=ow>in</span> <span class=n>command</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># we need the driver&#39;s PATH and PYTHONPATH in env to run mpirun,</span>
</span></span><span class=line><span class=cl>    <span class=c1># env for mpirun is different to env encoded in mpirun_command</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;PATH&#39;</span><span class=p>,</span> <span class=s1>&#39;PYTHONPATH&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>var</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>env</span> <span class=ow>and</span> <span class=n>var</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># copy env so we do not leak env modifications</span>
</span></span><span class=line><span class=cl>            <span class=n>env</span> <span class=o>=</span> <span class=n>copy</span><span class=o>.</span><span class=n>copy</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># copy var over from os.environ</span>
</span></span><span class=line><span class=cl>            <span class=n>env</span><span class=p>[</span><span class=n>var</span><span class=p>]</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=n>var</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Execute the mpirun command.</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>run_func_mode</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>exit_code</span> <span class=o>=</span> <span class=n>safe_shell_exec</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>mpirun_command</span><span class=p>,</span> <span class=n>env</span><span class=o>=</span><span class=n>env</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>stdout</span><span class=p>,</span> <span class=n>stderr</span><span class=o>=</span><span class=n>stderr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>execve</span><span class=p>(</span><span class=s1>&#39;/bin/sh&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;/bin/sh&#39;</span><span class=p>,</span> <span class=s1>&#39;-c&#39;</span><span class=p>,</span> <span class=n>mpirun_command</span><span class=p>],</span> <span class=n>env</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><h3 id=53-mpirun命令>5.3 mpirun命令</h3><p>因为 mpi_run 使用的是 mpirun 命令来运行，所以我们介绍一下。</p><p>mpirun是MPI程序的启动脚本，它简化了并行进程的启动过程，尽可能屏蔽了底层的实现细节，从而为用户提供了一个通用的MPI并行机制。</p><p>在用mpirun命令执行并行程序时，参数-np指明了需要并行运行的进程个数。mpirun首先在本地结点上启动一个进程，然后根据/usr/local/share/machines.LINUX文件中所列出的主机，为每个主机启动一个进程。若进程数比可用的并行节点数多，则多余的进程将重新按照上述规则进行。按这个机制分配好进程后，一般会给每个节点分一个固定的标号，类似于身份证了，后续在消息传递中会用到。</p><p>这里需要说明的是，实际运行的</p><p>orterun(Open MPI SPMD / MPMD启动器; mpirun / mpiexec只是它的符号链接)</p><p>命令举例如下：</p><div class=highlight id=id-36><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mpirun</span> <span class=o>-</span><span class=n>np</span> <span class=mi>4</span> \
</span></span><span class=line><span class=cl>    <span class=o>-</span><span class=n>bind</span><span class=o>-</span><span class=n>to</span> <span class=n>none</span> <span class=o>-</span><span class=nb>map</span><span class=o>-</span><span class=n>by</span> <span class=n>slot</span> \
</span></span><span class=line><span class=cl>    <span class=o>-</span><span class=n>x</span> <span class=n>NCCL_DEBUG</span><span class=o>=</span><span class=n>INFO</span> <span class=o>-</span><span class=n>x</span> <span class=n>LD_LIBRARY_PATH</span> <span class=o>-</span><span class=n>x</span> <span class=n>PATH</span> \
</span></span><span class=line><span class=cl>    <span class=o>-</span><span class=n>mca</span> <span class=n>pml</span> <span class=n>ob1</span> <span class=o>-</span><span class=n>mca</span> <span class=n>btl</span> <span class=o>^</span><span class=n>openib</span> \
</span></span><span class=line><span class=cl>    <span class=n>python</span> <span class=n>train</span><span class=o>.</span><span class=n>py</span></span></span></code></pre></td></tr></table></div></div><h2 id=6-总结>6 总结</h2><p>对比 gloo 和 mpi 的实现，我们还是能看出来区别。</p><h3 id=61-gloo>6.1 gloo</h3><p>gloo 只是一个库，需要 horovod 来完成命令分发功能。</p><p>gloo 需要 horovod 自己实现本地运行和远端运行方式，即 get_remote_command 函数 实现 <code>'ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no'</code>。</p><p>gloo 需要实现 RendezvousServer，底层会利用 RendezvousServer 进行通讯。</p><h3 id=62-mpi>6.2 mpi</h3><p>mpi 则功能强大很多，只要把命令配置成被 mpirun 包装，openmpi 就可以自行完成命令分发执行。说到底，horovod 是一个 mpirun 程序，即使运行了 tensor flow，也是一个mpi程序，可以互相交互。</p><p>references:
[1]. <a href=https://www.cnblogs.com/rossiXYZ/p/14881812.html target=_blank rel="external nofollow noopener noreferrer">https://www.cnblogs.com/rossiXYZ/p/14881812.html<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></p></div><div class=post-reward><div class=comment>Buy me a coffee~</div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward>赞赏</label><div class=reward-ways data-mode=fixed><div><img loading=lazy src=/images/alipay.png srcset="/images/alipay.png, /images/alipay.png 1.5x, /images/alipay.png 2x" sizes=auto data-title="Jian YE 支付宝" data-alt="Jian YE 支付宝" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span data-animation>支付宝</span></div><div><img loading=lazy src=/images/wechatpay.png srcset="/images/wechatpay.png, /images/wechatpay.png 1.5x, /images/wechatpay.png 2x" sizes=auto data-title="Jian YE 微信" data-alt="Jian YE 微信" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span data-animation>微信</span></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-07-15 15:28:35">更新于 2023-07-15&nbsp;<a class=git-hash href=https://github.com/jianye0428/JianBlog/commit/84e2876cfb14f359a6d6034596104deef86f29d1 rel="external nofollow noopener noreferrer" target=_blank title="commit by yejian(yejian@zhito.com) 84e2876cfb14f359a6d6034596104deef86f29d1: feat: add transformer introduction"><i class="fa-solid fa-hashtag fa-fw" aria-hidden=true></i>84e2876</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/2022-10-08_horovod_3/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span><span><a href=https://github.com/jianye0428/JianBlog/edit/docs/content/posts/Horovod/2022-10-08_horovod_3/index.md title=编辑此页 target=_blank rel="external nofollow noopener noreferrer" class=link-to-edit>编辑此页</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://jianye0428.github.io/posts/2022-10-08_horovod_3/ data-title="深度学习分布式训练框架 horovod[3] -- Horovodrun背后做了什么" data-hashtags=Horovod><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://jianye0428.github.io/posts/2022-10-08_horovod_3/ data-hashtag=Horovod><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://jianye0428.github.io/posts/2022-10-08_horovod_3/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://jianye0428.github.io/posts/2022-10-08_horovod_3/ data-title="深度学习分布式训练框架 horovod[3] -- Horovodrun背后做了什么"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://jianye0428.github.io/posts/2022-10-08_horovod_3/ data-title="深度学习分布式训练框架 horovod[3] -- Horovodrun背后做了什么"><i data-svg-src=/lib/simple-icons/icons/baidu.min.svg aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/horovod/ class=post-tag>Horovod</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/2022-10-08_horovod_2/ class=post-nav-item rel=prev title="深度学习分布式训练框架 Horovod[2] -- 从使用者角度切入"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>深度学习分布式训练框架 Horovod[2] -- 从使用者角度切入</a>
<a href=/posts/2022-10-08_horovod_4/ class=post-nav-item rel=next title="深度学习分布式训练框架 horovod[4] -- 网络基础 & Driver">深度学习分布式训练框架 horovod[4] -- 网络基础 & Driver<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.122.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2018 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/jianye0428 target=_blank rel="external nofollow noopener noreferrer">Jian YE</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics order-first"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="ms-1 d-none">博客已运行</span><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://github.com/jianye0428/JianBlog title="在 GitHub 上查看程式碼，訂閱請點 Watch" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:#000;--bg-progress-dark:#fff></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script src=/lib/instant-page/instantpage.min.js async defer type=module></script><script src=/lib/twemoji/twemoji.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=/lib/cell-watermark/watermark.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:50},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,pangu:{enable:!0,selector:"article"},search:{algoliaAppID:"MTJNHU0JVB",algoliaIndex:"index",algoliaSearchKey:"5486225134d99f43826da401ee9bad57",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},siteTime:"2018-05-28T20:01:01+08:00",twemoji:!0,watermark:{appendto:".wrapper>main",colspacing:30,content:'<img style="height: 0.85rem;" src="/images/favicon/jian_icon.png" alt="logo" /> jianye',enable:!0,fontfamily:"MMT_LRH,沐目体",fontsize:1.1,height:20,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script></body></html>